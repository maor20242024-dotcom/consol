
## تقييم شامل للمشروع: "IMPERIUM GATE"

المشروع يمتلك رؤية قوية وتصميماً بصرياً جذاباً جداً (خاصة مع لوحة الألوان الذهبية والداكنة وتأثيرات الـ Glassmorphism). استخدام Next.js وSupabase وPrisma وShadcn/ui هو اختيار عصري وممتاز. ومع ذلك، هناك عدة نقاط حاسمة تحتاج للتصحيح والتطوير للارتقاء بالمشروع إلى مستوى يليق بمفهوم "AI Marketing Specialist".

### الملاحظات الأولية عالية المستوى:

1.  **تضارب وتكرار الملفات (Critical)**: توجد مشكلة كبيرة في تكرار ملفات بنفس المسمى الوظيفي أو الغرض، مما يخلق تضارباً في المسارات (Routes) ومنطق العمل.
2.  **أدوات بناء متضاربة (Critical)**: وجود ملف `vite.config.ts` في مشروع Next.js هو مؤشر خطير على تضارب في بيئة البناء.
3.  **إصدارات تجريبية (Critical Risk)**: استخدام Next.js v15 وReact v19 وTailwind CSS v4 (جميعها إصدارات تجريبية أو ما قبل الإصدار) يمثل خطراً كبيراً على استقرار المشروع وأمنه في بيئة الإنتاج.
4.  **الذكاء الاصطناعي الوهمي (Core Feature Gap)**: بالرغم من أن المشروع يركز على "الذكاء الاصطناعي"، فإن معظم وظائف الذكاء الاصطناعي حالياً هي "وهمية" أو "محاكاة". هذا هو لب المشروع الذي يحتاج إلى تفعيل حقيقي.
5.  **الترجمة واللغات (Inconsistent)**: بالررغم من استخدام `next-intl`، هناك تكرار كبير للترجمة الشرطية في الكود (`locale === "ar" ? "..." : "..."`) بدلاً من استخدام وظائف الترجمة الموحدة `t()`.
6.  **البيانات الوهمية (Production Readiness)**: تعتمد العديد من الصفحات على بيانات وهمية أو محاكاة بدلاً من الربط الفعلي بقواعد البيانات أو الـ APIs.

---

## تقييم وتصحيحات مفصلة لكل ملف:

#### **`app2/index.tsx`**
*   **تصحيح/ملاحظة**: ملف فارغ، لا توجد مشكلة.

#### **`app2/middleware.ts`**
*   **تصحيح/ملاحظة**:
    *   الكود سليم ويتبع أفضل الممارسات لتكامل `next-intl` والمصادقة عبر Supabase SSR.
    *   استخدام `createServerClient` في الـ Middleware مع `req.cookies.getAll()` صحيح تماماً لمعالجة الـ `session`.
*   **تحسينات/أفكار تسويقية**:
    *   **مسارات الحماية المركزية**: يمكن نقل مصفوفة `protectedPaths` إلى ملف إعدادات مشترك (`config/auth.ts`) لتحسين إدارتها والرجوع إليها من أجزاء أخرى من التطبيق (مثال: إخفاء عناصر التنقل لغير المصرح لهم).
    *   **تسجيل الدخول الموحد**: في حالة عدم وجود `session`، يتم إعادة التوجيه إلى `/${locale}/login`. يجب التأكد من أن هذه الصفحة فعلاً هي الصفحة المخصصة لتسجيل الدخول الفعلي مع Supabase.

#### **`app2/next-i18next.config.js`**
*   **خطأ حرج**: هذا الملف خاص بمكتبة `next-i18next` بينما المشروع يستخدم `next-intl`. يسبب تضارباً ولا فائدة منه.
*   **تصحيح**: **يجب حذف هذا الملف بالكامل**.

#### **`app2/index.html`**
*   **ملاحظة**: وجود `importmap` وCDN `aistudiocdn.com` يشير إلى أن المشروع مصمم للعمل في بيئة "AI Studio" خاصة. سأفترض هذا هو السياق التشغيلي ولن أعتبره خطأ في Next.js التقليدي.

#### **`app2/vercel.json`**, **`app2/metadata.json`**, **`app2/next-env.d.ts`**, **`app2/README.md`**
*   **تصحيح/ملاحظة**: هذه الملفات سليمة ولا توجد بها مشكلات جوهرية.

#### **`app2/tailwind.config.ts`**
*   **خطأ حرج (إصدار Tailwind)**: استخدام `tailwindcss@^4.1.17` هو خطأ فادح. Tailwind CSS v4 حالياً في مرحلة "ما قبل ألفا" (pre-alpha) وغير مستقر على الإطلاق وغير موصى به للإنتاج. هذا سيتسبب بمشاكل توافقية واستقرار لا حصر لها.
*   **تصحيح**:
    1.  **العودة إلى Tailwind CSS v3**: قم بتعديل `package.json` ليصبح `tailwindcss": "^3.x.x"` (أحدث إصدار مستقر من v3).
    2.  تعديل `app/globals.css` لإزالة `@custom-variant dark (&:is(.dark *));` إذا كانت هذه ميزة خاصة بـ v4 وليست جزءاً من المخطط الأصلي. (بما أن المشروع يستخدم Shadcn/ui التي عادة ما تكون متوافقة مع v3، فمن الأرجح أن هذه هي المشكلة).
    3.  التحقق من `tw-animate-css` إذا كان لا يزال ضرورياً بعد العودة إلى v3 أو إذا كان `tailwindcss-animate` يغطيه.
*   **تحسينات/أفكار تسويقية**:
    *   **لوحة الألوان وتأثيرات الـ UI**: اختيار الألوان (Deep Navy Blue و Luxury Gold) وتأثيرات الـ Glassmorphism والأنيميشن (`float`, `shimmer`, `glow`) ممتازة جداً وتمنح المنتج شعوراً بالفخامة والرقي المطلوب لـ "Imperium Gate". هذه نقاط قوة كبيرة في تجربة المستخدم.
    *   **تطوير الأنيميشن**: يمكن استخدام أنيميشن مثل `shimmer` و `glow` على عناصر لوحة التحكم عند تحديث البيانات أو عند ظهور "رؤى الذكاء الاصطناعي" الجديدة لجذب انتباه المستخدم وإبراز أهمية المعلومات.

#### **`app2/package.json`**
*   **أخطاء حرجة**:
    *   **إصدارات Next.js و React**: استخدام `next": "15.3.5"` و `react": "^19.0.0"` و `react-dom": "^19.0.0"` هي إصدارات تجريبية أو ما قبل الإصدار. هذا خطر كبير على الاستقرار والأمان.
    *   **Tailwind CSS v4**: كما ذكر أعلاه، استخدام v4 غير مقبول للإنتاج.
    *   **`nodemon`**: عادةً لا يُستخدم في مشاريع Next.js بهذه الطريقة. على الأرجح هو جزء متبقي أو خطأ في التهيئة.
    *   **تضارب إصدارات `next-intl`**: `^4.5.3` في `package.json` و `^4.5.5` في `index.html`.
*   **تصحيح**:
    1.  **العودة لإصدارات مستقرة**:
        *   `next": "^14.x.x"` (أحدث إصدار مستقر من 14).
        *   `react": "^18.x.x"` و `react-dom": "^18.x.x"`.
        *   `tailwindcss": "^3.x.x"`.
    2.  **تنظيف التبعيات**: حذف `nodemon` إذا لم يكن هناك استخدام محدد وخاص به.
    3.  **توحيد إصدار `next-intl`**: تأكد من تطابق الإصدار في `package.json` وفي `index.html` (إذا كان `index.html` هو المصدر الموثوق للـ CDN).

#### **`app2/tsconfig.json`**
*   **أخطاء/ملاحظات**:
    *   `"target": "ES2017"`: قديم بعض الشيء. `ES2022` أو `ESNext` أفضل.
    *   `"noImplicitAny": false`: هذا يقلل من فائدة TypeScript.
    *   `"paths": { "@/": ["./src/*"] }`: المشروع لا يلتزم بهيكل `src` بالكامل (مثل `app/`). هذا قد يسبب عدم اتساق.
*   **تصحيح**:
    1.  تغيير `"target"` إلى `"ES2022"`.
    2.  تغيير `"noImplicitAny"` إلى `true` ومعالجة أي أخطاء أنواع ستظهر. هذا يعزز جودة الكود.
    3.  توحيد هيكل المشروع (إما كل شيء في `src` أو تعديل `paths` ليعكس الهيكل الحالي بشكل أفضل).

#### **`app2/vite.config.ts`**
*   **خطأ حرج**: هذا الملف خاص بأداة بناء Vite. مشاريع Next.js لا تستخدم Vite لعملية البناء الأساسية.
*   **تصحيح**: **يجب حذف هذا الملف بالكامل**. إنه مجرد ملف متبقي ويسبب تضارباً.

#### **`app2/next.config.ts`**
*   **تصحيح/ملاحظة**: سليم. تهيئة `next-intl` و`output: 'standalone'` صحيحة.

#### **`app2/messages/en.json` & `app2/messages/ar.json`**
*   **تصحيح/ملاحظة**: هياكل الـ JSON سليمة والترجمات موجودة.
*   **تحسينات/أفكار تسويقية**:
    *   **توحيد مفاتيح الترجمة**: هناك بعض عدم الاتساق (مثال: `overview` في القائمة الجانبية يقابلها `Dashboard.title` في صفحة لوحة التحكم). يُفضل توحيد المفاتيح قدر الإمكان.
    *   **لغة التسويق الفاخرة**: الترجمات العربية ممتازة وتستخدم لغة فخمة وملكية تتناسب مع هوية "Imperium Gate" ("قيصر الإمبراطورية"، "مركز القيادة المركزي"). هذا يعزز هوية العلامة التجارية.
    *   **تطوير رسائل الـ AI**: يمكن إضافة مفاتيح ترجمة لرسائل الذكاء الاصطناعي المحتملة أو الاقتراحات التلقائية لضمان اتساق النبرة واللغة.

#### **`app2/app/layout.tsx` (Root Layout)**
*   **تصحيح/ملاحظة**: يستخدم Geist fonts و Shadcn Toaster بشكل صحيح.
*   **أخطاء/ملاحظات**:
    *   `lang="en"` الثابت: لا يجب أن يكون ثابتًا هنا. بما أن هناك `app/[locale]/layout.tsx`، فإن هذه الـ Root Layout ستُطبق قبل تحديد الـ `locale`، مما قد يجعل الـ `lang` غير صحيح في التحميل الأولي.
*   **تصحيح**:
    *   نظرًا لوجود `app/[locale]/layout.tsx`، يمكن تقليل دور هذا الملف أو إزالته إذا كانت تهيئة الـ `<html>` يمكن نقلها بالكامل إلى الـ Locale Layout. إذا كان يجب أن يبقى، يجب أن يكون دوره محددًا جداً ولا يتدخل في سمات الـ `<html>` التي تُحدد في الـ Locale Layout.

#### **`app2/app/page.tsx`**
*   **تصحيح/ملاحظة**: سليم، يعيد التوجيه إلى `/en` كمسار افتراضي.

#### **`app2/app/globals.css`**
*   **خطأ حرج (Tailwind v4)**: تأكيد استخدام `@custom-variant dark (&:is(.dark *));` يشير إلى Tailwind CSS v4. هذا يجب تصحيحه بالعودة إلى v3 (انظر `tailwind.config.ts`).
*   **تصحيح**: العودة إلى Tailwind CSS v3 والتأكد من توافق جميع الـ `@apply` والـ `utilities` المخصصة.
*   **تحسينات/أفكار تسويقية**:
    *   **هوية بصرية قوية**: الـ CSS المخصص لتأثيرات الـ `glass`، `text-gradient-gold`، وScrollbar الفاخرة، والخطوط المميزة، كلها تعزز هوية "Imperium Gate" الفاخرة والعصرية. هذا جانب قوي جداً في التصميم.
    *   **تحسين Scrollbar**: يمكن جعل الـ Scrollbar أكثر أناقة في بيئات معينة، وهو ما تم بالفعل.

#### **`app2/components/page-shell.tsx`**
*   **تصحيح/ملاحظة**: مكون `PageShell` ممتاز لإعادة الاستخدام ويوفر هيكلاً موحداً للصفحات.
*   **تحسينات/أفكار تسويقية**:
    *   **شكل الـ Gradient**: `variant="gradient"` للعناوين الكبيرة يضفي لمسة جمالية فاخرة جداً تتناسب مع العلامة التجارية.
    *   **زر العودة**: مرونة زر العودة (باستخدام `backHref` أو `router.back()`) جيدة لتجربة المستخدم.

#### **`app2/components/ImperiumLogo.tsx`**
*   **تصحيح/ملاحظة**: سليم.

#### **`app2/components/app-sidebar.tsx`**
*   **تصحيح/ملاحظة**: يستخدم Framer Motion للأنيميشن وهو اختيار جيد.
*   **أخطاء/ملاحظات**:
    *   **اتجاه الشريط الجانبي في RTL**: حالياً، الشريط الجانبي يفتح من اليمين (`right-0`) ويتحرك إلى اليمين (`x: 0 : 320`) في كلتا اللغتين. بالنسبة للعربية (RTL)، يجب أن يكون الشريط الجانبي على اليسار (`left-0`) وأن يتحرك إلى اليسار (`x: 0 : -320`) للحفاظ على تجربة المستخدم الطبيعية.
*   **تصحيح**:
    1.  تعديل `className` لـ `motion.aside` ليكون `fixed left-0` و `initial={{ x: sidebarOpen ? 0 : -320 }}` (أو ما شابه) عندما تكون اللغة عربية.
    2.  تعديل `ml-auto` لـ `Sparkles` إلى `mr-auto` في RTL.
    3.  جميع الـ icons التي تستخدم `ml-3` أو `mr-2` تحتاج إلى تعديل شرطي لـ `rtl`.
*   **تحسينات/أفكار تسويقية**:
    *   **علامة تجارية قوية**: دمج شعار التاج (`Crown`) مع اسم "IMPERIUM GATE" والتدرج الذهبي يعزز الهوية الملكية للمنتج.
    *   **مؤشر النشاط**: أيقونة `Sparkles` للعناصر النشطة في القائمة الجانبية لمسة رائعة وجذابة.
    *   **مبدل اللغات**: وجود مبدل لغة واضح في الشريط الجانبي مهم جداً لتطبيق متعدد اللغات.

#### **`app2/components/FloatingDots.tsx`**
*   **تصحيح/ملاحظة**: مكون جيد لإضافة لمسة جمالية خفية ومتحركة في الخلفية. استخدام `useMemo` وSSR disabled جيد.
*   **تحسينات/أفكار تسويقية**: يضيف هذا المكون إحساساً عصرياً وتكنولوجياً يتناسب مع منتج يعتمد على الذكاء الاصطناعي.

#### **`app2/components/language-switcher.tsx` (Duplicate Files)**
*   **خطأ حرج**: وجود ملفين متطابقين (`language-switcher.tsx` و `LanguageSwitcher.tsx`) هو مصدر كبير للتضارب. أحدهما يستخدم `router.push` (أفضل) والآخر `window.location.href` (أقل كفاءة).
*   **تصحيح**:
    1.  **اختر النسخة الأفضل**: النسخة التي تستخدم `useRouter` و `usePathname` هي الأفضل.
    2.  **احذف الأخرى**: احذف الملف المكرر تماماً.
    3.  **توحيد الاستدعاءات**: تأكد من أن أي مكان يستدعي هذا المكون يستدعي النسخة المتبقية فقط. (ملاحظة: الـ `app-sidebar.tsx` يقوم بالتبديل اللغوي داخليًا ولا يستخدم هذا المكون).

#### **`app2/public/robots.txt`**
*   **تصحيح/ملاحظة**: سليم.

#### **`app2/hooks/use-mobile.ts`**
*   **تصحيح/ملاحظة**: سليم.

#### **`app2/hooks/use-toast.ts`**
*   **خطأ**: `TOAST_REMOVE_DELAY = 1000000` (مليون ميلي ثانية أو حوالي 16 دقيقة) مدة طويلة جداً لرسائل التوست. ستظل رسائل التوست تظهر لوقت طويل جداً.
*   **تصحيح**: تقليل `TOAST_REMOVE_DELAY` إلى قيمة معقولة (مثال: `5000` لـ 5 ثوانٍ).

#### **`app2/lib/ai-suggestions.ts`**
*   **ملاحظة جوهرية (تطوير الذكاء الاصطناعي)**: هذا الملف حالياً يقدم "محاكاة" لاقتراحات الذكاء الاصطناعي. هذا هو المكان الأساسي لتطوير الذكاء الاصطناعي الحقيقي.
*   **تحسينات/أفكار تسويقية (تفعيل الذكاء الاصطناعي)**:
    *   **الربط بنماذج الـ LLM**: استبدال المنطق الوهمي بربط فعلي مع نماذج لغوية كبيرة (مثل Gemini, OpenAI GPT, OpenRouter) عبر الـ API الخاص بـ `/api/ai-agent`.
    *   **التحليل السياقي المتقدم**: بدلاً من القوالب العشوائية، يجب أن تأخذ الاقتراحات في الاعتبار:
        *   اسم المنتج، الوصف، الجمهور المستهدف.
        *   بيانات أداء الحملات السابقة (من التحليلات).
        *   الكلمات المفتاحية ذات الصلة بالـ SEO.
        *   نبرة العلامة التجارية (ملكيه، فاخره، عمليه).
    *   **توليد أشكال متعددة**: يجب أن يكون الـ AI قادراً على توليد 2-3 اقتراحات مختلفة (رؤوس أقلام، أوصاف، CTA) لإجراء اختبار A/B بسهولة.
    *   **توليد الأصول البصرية**: يمكن للـ AI اقتراح أفكار للصور/الفيديوهات أو حتى توليد صور بسيطة أو تحسين صور موجودة بناءً على نص الإعلان.
    *   **تحليل المشاعر**: إذا كانت هناك بيانات عن استجابات العملاء، يمكن للـ AI تحليل المشاعر لتقديم اقتراحات أكثر إقناعاً.

#### **`app2/lib/utils.ts`**
*   **تصحيح/ملاحظة**: سليم.

#### **`app2/lib/supabase.ts`**
*   **خطأ محتمل (أمني)**: تصدير `supabaseAdmin` بشكل عام (`export const supabaseAdmin`) يزيد من مخاطر التعرض، فإذا تم استدعاؤه بطريق الخطأ في كود العميل، سيتسبب في ثغرة أمنية خطيرة (تجاوز Row Level Security).
*   **تصحيح**:
    1.  **عدم تصدير `supabaseAdmin`**: الأفضل هو عدم تصدير `supabaseAdmin` من هذا الملف.
    2.  **الاستدعاء المحلي**: قم باستدعاء `createClient` مباشرة داخل الـ API Routes أو Server Actions التي تحتاج إلى امتيازات المسؤول، بحيث لا يتعرض مفتاح `SERVICE_ROLE_KEY` إلا في السياق المناسب.

#### **`app2/lib/db.ts`**
*   **تصحيح/ملاحظة**: سليم، يستخدم Prisma Client مع نمط Singleton.

#### **`app2/lib/instagram-storage.ts`**
*   **تصحيح/ملاحظة**: يوفر دوال لتحميل وحذف الأصول.
*   **تحسينات/أفكار تسويقية**:
    *   **RLS في Supabase Storage**: تأكد من وجود سياسات Row Level Security (RLS) قوية على bucket الـ `ad-assets` في Supabase لضمان أن المستخدمين يمكنهم الوصول أو التعديل فقط على الأصول الخاصة بهم/بحملاتهم.
    *   **توليد صور مصغرة (Thumbnails)**: التعليق يشير إلى استخدام نفس الرابط للـ thumbnail. لتجربة مستخدم أفضل (خاصة للفيديوهات)، يجب توليد صور مصغرة حقيقية على الخادم (مثال: باستخدام Supabase Edge Functions أو `sharp` في API Route).
    *   **تحسين الأصول بالذكاء الاصطناعي**:
        *   **تحسين الصور/الفيديوهات**: يمكن للـ AI تحسين جودة الأصول، اقتراح قصات مثالية، أو حتى تعديل الألوان لتناسب أفضل لغة إعلانية.
        *   **تصنيف الأصول**: يمكن للـ AI تصنيف الأصول تلقائياً (مثال: "فلل"، "شقق"، "دبي مارينا") لتسهيل البحث والاستخدام.

#### **`app2/i18n/routing.ts` & `app2/i18n/request.ts`**
*   **تصحيح/ملاحظة**: سليمة لتهيئة `next-intl`.
*   **تحسينات**:
    *   **مسارات ديناميكية**: لتطبيق كبير، يمكن استكشاف كيفية التعامل مع المسارات الديناميكية (مثل `campaigns/[id]`) في `pathnames` لـ `next-intl` بدلاً من سرد كل مسار يدويًا.

#### **`app2/app/[locale]/layout.tsx` (Locale Layout)**
*   **تصحيح/ملاحظة**: ممتاز لتهيئة Locale-specific (اللغة والاتجاه `dir`).
*   **أخطاء/ملاحظات**:
    *   **Sidebar Position**: نفس مشكلة `app-sidebar.tsx`، الشريط الجانبي ثابت على اليمين حتى في وضع RTL.
*   **تصحيح**: يجب أن يتوافق مع تعديلات `app-sidebar.tsx` ليتم تعديل اتجاهه وفتحه لـ RTL.
*   **تحسينات**:
    *   **تجربة المستخدم للـ RTL**: التأكد من أن جميع عناصر واجهة المستخدم والتباعد تتكيف بشكل صحيح مع اتجاه `rtl`.

#### **`app2/app/[locale]/page.tsx` (Locale Home Page)**
*   **تصحيح/ملاحظة**: يستخدم `PageShell` و `FloatingDots` بشكل صحيح.
*   **أخطاء/ملاحظات**:
    *   **الترجمة الناقصة**: بعض النصوص لا تزال إنجليزية ثابتة ("Review dashboards", "Open AI assistant").
*   **تصحيح**: استخدام `t()` لجميع النصوص الموجهة للمستخدم.
*   **تحسينات/أفكار تسويقية**:
    *   **محتوى ديناميكي مدعوم بالذكاء الاصطناعي**: يمكن لصفحة البداية عرض "رؤى سريعة" أو "توصيات شخصية" من الذكاء الاصطناعي بناءً على دور المستخدم أو حالة النظام.
    *   **أزرار CTA ذكية**: يمكن للـ AI تخصيص أزرار "Review dashboards" و "Open AI assistant" لتعكس الأولويات الحالية للمستخدم (مثال: إذا كانت هناك حملة تحتاج مراجعة، يبرز زر مراجعة الحملات).

#### **`app2/app/dashboard/page.tsx` (Client-side, Old)**
*   **خطأ حرج**: هذا الملف متضارب مع `app2/app/[locale]/dashboard/page.tsx` (النسخة Server-side).
*   **تصحيح**: **يجب حذف هذا الملف بالكامل**.

#### **`app2/app/[locale]/dashboard/page.tsx` (Server-side, Correct one)**
*   **تصحيح/ملاحظة**: يستخدم Server Components و Prisma و `getTranslations` بشكل صحيح.
*   **أخطاء**:
    *   **الترجمة الناقصة في Server Components**: يتم استخدام الشرط `locale === "ar" ? "..." : "..."` بدلاً من `await t('key')` في العديد من الأماكن (العنوان، الوصف، Labels، Details في الـ panels).
    *   **استخدام `getTranslations`**: `const t = getTranslations({ locale });` يجب أن يتم `await` عليها قبل استخدام `t()` كدالة. `const t = await getTranslations({ locale });`
*   **تصحيح**:
    1.  تعديل `const t = await getTranslations({ locale });`.
    2.  تطبيق `t('key')` على جميع النصوص المترجمة.
*   **تحسينات/أفكار تسويقية**:
    *   **لوحة تحكم تفاعلية مدعومة بالذكاء الاصطناعي**:
        *   **رؤى قابلة للتنفيذ**: لا تعرض البيانات فقط. يجب أن يقدم الـ AI "ماذا يجب أن تفعل بعد ذلك؟". مثال: "تم تحديد 3 فرص جديدة في دبي مارينا. اقترح حملة جديدة."
        *   **تنبيهات استباقية**: يمكن للـ AI تحليل بيانات الأداء (من التحليلات) وتقديم تنبيهات حول الحملات ذات الأداء الضعيف أو الميزانيات التي على وشك النفاذ.
        *   **خرائط حرارية (Heatmaps)**: تصور النشاط الجغرافي للعملاء المحتملين أو الحملات.
        *   **تخصيص لوحة التحكم**: يمكن للمستخدمين تخصيص لوحات التحكم الخاصة بهم بناءً على أهمية المعلومات بالنسبة لهم.
        *   **نظرة عامة على الـ Pulse**: هذا القسم ممتاز. يمكن أن يعرض تدفقاً حياً للعمليات الهامة التي يديرها الـ AI (مكالمات صوتية، تفاعلات المساعد، إطلاق حملات).
    *   **الربط بالبيانات الحقيقية**: استبدال `systemHealth: 98.5` و `totalSpend: "0"` ببيانات حقيقية من الخدمات الخلفية.

#### **`app2/app/api/route.ts`**
*   **تصحيح/ملاحظة**: سليم كـ API صحة/معلومات أساسي.

#### **`app2/app/login/page.tsx` (Client-side, Old)**
*   **خطأ حرج**: هذا الملف متضارب مع `app2/app/[locale]/login/page.tsx`.
*   **تصحيح**: **يجب حذف هذا الملف بالكامل**.

#### **`app2/app/[locale]/login/page.tsx` (Client-side, Correct one)**
*   **تصحيح/ملاحظة**: يستخدم SupabaseAuth بشكل صحيح ويوفر تجربة تسجيل دخول جيدة.
*   **أخطاء**:
    *   **نقص الترجمة**: معظم النصوص إنجليزية ثابتة (Email, Password, Login, Logging in...).
    *   **"Remember me" missing**: النسخة المحذوفة كانت تحتوي على checkbox "Remember me" بينما هذه لا.
*   **تصحيح**:
    1.  استخدام `t()` لجميع النصوص القابلة للترجمة.
    2.  إذا كان مطلوباً، إضافة وظيفة "تذكرني" (`remember me`) بالربط مع خيارات `signInWithPassword` (عادةً Supabase يدعم تذكر الجلسة تلقائياً).
*   **تحسينات/أفكار تسويقية**:
    *   **شاشة تحميل فاخرة**: عند `isLoading`، يمكن عرض أنيميشن أكثر فخامة بدلاً من spinner بسيط.
    *   **إعداد Supabase**: الرسالة التوضيحية عن إعداد Supabase مفيدة جداً للمطورين.

#### **`app2/components/ui/*.tsx`**
*   **ملاحظة عامة**: مكونات Shadcn/ui تم إنشاؤها وتعديلها.
*   **أخطاء/ملاحظات**:
    *   **`use-toast.ts`**: لا يزال يعاني من مشكلة `TOAST_REMOVE_DELAY`.
    *   **RTL Styling**: في العديد من المكونات، قد تحتاج بعض التعديلات الدقيقة في الـ CSS (مثل `ml-2` مقابل `mr-2`) للتعامل مع اتجاه `rtl` بشكل مثالي.

#### **`app2/components/ui/docs/ARCHIVE/README.md`**
*   **تصحيح/ملاحظة**: ملف تنظيمي جيد، يُفضل المتابعة في أرشفة الملفات المذكورة.

#### **`app2/app/[locale]/settings/page.tsx`**
*   **تصحيح/ملاحظة**: يستخدم `PageShell` و `FloatingDots` والـ Tabs.
*   **أخطاء**:
    *   **الترجمة الناقصة**: الكثير من النصوص إنجليزية ثابتة بدلاً من `t()`.
    *   **نقص وظائف الحفظ**: زر "Save Changes" حالياً لا يفعل شيئاً. يجب أن يقوم بإرسال البيانات إلى API.
    *   **نقص Backend**: جميع الإعدادات يتم تحديثها محلياً فقط في الـ `useState` ولا يتم حفظها في قاعدة البيانات.
*   **تصحيح**:
    1.  استخدام `t()` لجميع النصوص.
    2.  تطبيق React Hook Form و Zod للتحقق من صحة المدخلات.
    3.  تنفيذ API Endpoints لحفظ الإعدادات لكل قسم (General, Notifications, Privacy, Security, Billing).
    4.  ربط الإعدادات الفعلية بـ Supabase (مثال: تحديث البروفايل، تفعيل 2FA).
    5.  **مبدل اللغة**: يجب أن يقوم بتغيير الـ `locale` عبر `router.push()` عند اختيار لغة جديدة.
*   **تحسينات/أفكار تسويقية**:
    *   **إعدادات الذكاء الاصطناعي**: يمكن إضافة تبويب جديد لإعدادات الذكاء الاصطناعي، مثل:
        *   "نبرة المساعد الذكي" (Tone of AI Assistant: Formal, Imperial, Casual).
        *   "مستوى استخدام البيانات للتحسين" (Data Usage for Personalization).
        *   "إشعارات توصيات الـ AI".
    *   **تكامل الفواتير الحقيقي**: ربط قسم الفواتير بمنصة دفع (مثل Stripe) لعرض الخطط والفواتير الحقيقية.
    *   **تأمين الحساب**: ربط "Change Password" و "Enable Two-Factor Authentication" بوظائف Supabase Auth الحقيقية.

#### **`app2/app/[locale]/ad-creator/client.tsx` & `app2/app/[locale]/ad-creator/page.tsx`**
*   **تصحيح/ملاحظة**: يستخدم `PageShell`، `FloatingDots`، Tabs، و `lib/ai-suggestions.ts`.
*   **أخطاء**:
    *   **نقص الترجمة**: بعض النصوص ثابتة (مثال: "Please upload at least one image or video", "Generating...", "Success", "Error").
    *   **تضارب `asset.type` و `asset.assetType`**: في `handleFileUpload`، يتم التحقق من `asset.type` بينما الـ API يرجع `asset.assetType`.
*   **تصحيح**:
    1.  استخدام `t()` لجميع النصوص.
    2.  توحيد اسم الخاصية إلى `assetType` في الـ frontend أو تعديل الـ backend.
    3.  إضافة `campaignId` إلى `handleCreateAd` حيث أن الـ `searchParams.get("campaignId")` قد يكون فارغاً.
*   **تحسينات/أفكار تسويقية (تفعيل الذكاء الاصطناعي)**:
    *   **توليد الإعلانات بالذكاء الاصطناعي (حقيقي)**: هذا هو قلب ميزة "منشئ الإعلانات". استبدل `generateHelineSuggestion` و `generateDescriptionSuggestion` بالربط الفعلي مع نماذج LLM قوية.
        *   **مدخلات سياقية**: يجب أن يأخذ الـ AI في الاعتبار اسم الحملة، الميزانية، الجمهور المستهدف، وحتى بيانات الأداء السابقة لتوليد نصوص إعلانية فعالة.
        *   **أزرار "AI Suggestion" الديناميكية**: يمكن أن تكون هذه الأزرار أكثر ذكاءً، مثلاً إذا لم يتم إدخال شيء، يقترح الـ AI أفكارًا عامة.
    *   **التحقق من جودة الإعلان بالذكاء الاصطناعي**: قبل النشر، يمكن للـ AI تقييم جودة الإعلان (Headline Strength, Image Relevance, CTA Clarity) وتقديم اقتراحات للتحسين.
    *   **توليد أصول بصرية (Visual Assets)**: يمكن للـ AI أن يقترح أنواعاً معينة من الصور/الفيديوهات أو حتى توليد صور بسيطة أو تحسين الصور المرفوعة لتناسب معايير الإعلان.
    *   **مكتبة الوسائط المتقدمة**: بدلاً من مجرد قائمة بالملفات المرفوعة، يجب أن يكون هناك معرض للوسائط مع صور مصغرة، إمكانيات بحث، وتصنيف تلقائي بالذكاء الاصطناعي.
    *   **تكامل اختبار A/B**: يمكن للـ AI توليد عدة نسخ من الإعلان، ويمكن للمنصة أن تسهل اختبار A/B تلقائياً.

#### **`app2/app/[locale]/crm/page.tsx`**
*   **تصحيح/ملاحظة**: يستخدم Supabase لـ CRUD على Leads، و `PageShell`، `FloatingDots`.
*   **أخطاء**:
    *   **الترجمة الناقصة في الحالات**: لا تزال ترجمة حالات العملاء (`statusText`, `badgeStyle`) تستخدم الـ `if/else` الشرطي بدلاً من مفاتيح الترجمة في `ar.json` (مثال: `CRM.hot`, `CRM.warm`).
    *   **زر التعديل معطل**: زر `Edit2` معطل حالياً.
*   **تصحيح**:
    1.  استخدام `t('CRM.hot')` وهكذا لجميع حالات العميل.
    2.  تفعيل وظيفة التعديل (`Edit Lead`).
*   **تحسينات/أفكار تسويقية (تفعيل الذكاء الاصطناعي)**:
    *   **نقاط تقييم العميل بالذكاء الاصطناعي (AI Lead Scoring)**: بدلاً من الحالة `hot` الافتراضية للعملاء الجدد، يجب أن يقوم الـ AI بتحليل بيانات العميل (المصدر، الميزانية، التفاعلات السابقة، الاهتمامات) لإنشاء "نقاط تقييم" ديناميكية (مثال: 0-100) وتحديثها باستمرار.
    *   **أتمتة متابعة العملاء (AI Lead Nurturing)**: يمكن للـ AI اقتراح أو أتمتة إجراءات المتابعة بناءً على حالة العميل ونقاط تقييمه (مثال: "إرسال بريد إلكتروني تلقائي لعميل دافئ"، "جدولة مكالمة مع عميل ساخن").
    *   **ملخصات العملاء بالذكاء الاصطناعي**: يمكن للـ AI توليد ملخصات سريعة لملف العميل، بما في ذلك تفضيلاته، احتمالية التحويل، وأفضل طريقة للتواصل معه.
    *   **لوحة Pipeline مرئية**: إضافة لوحة Kanban مرئية لـ "خط الأنابيب" للعملاء (New, Warm, Hot, Closed, Lost) مع إمكانية السحب والإفلات.
    *   **فلاتر وبحث متقدم**: إضافة فلاتر للحالة، المصدر، نقاط التقييم، وتاريخ آخر تواصل.
    *   **تتبع الأنشطة**: عرض سجل الأنشطة لكل عميل (المكالمات، رسائل البريد الإلكتروني، زيارات الموقع).

#### **`app2/app/[locale]/admin/page.tsx`**
*   **تصحيح/ملاحظة**: يستخدم Supabase لعد الإحصائيات، `PageShell`، `FloatingDots`.
*   **أخطاء**:
    *   **الترجمة الناقصة**: الكثير من النصوص إنجليزية ثابتة أو تستخدم الشرط اليدوي بدلاً من `t()`.
    *   **جدول `profiles`**: استدعاء `supabase.from("profiles")` يتطلب التأكد من وجود جدول بهذا الاسم وتكوينه بشكل صحيح (عادة يتم ربطه بـ `auth.users`).
    *   **"Coming soon..."**: الأقسام (Users, Campaigns, Settings) لا تزال تظهر رسائل "Coming soon...".
*   **تصحيح**:
    1.  استخدام `t()` لجميع النصوص.
    2.  تأكيد وجود وتكوين جدول `profiles` أو استخدام `auth.users` بشكل صحيح.
    3.  تطوير وظائف كاملة (CRUD) لإدارة المستخدمين والحملات والإعدادات.
*   **تحسينات/أفكار تسويقية (تفعيل الذكاء الاصطناعي)**:
    *   **صحة النظام التنبؤية بالذكاء الاصطناعي**: بدلاً من `systemHealth: 98.5` الثابت، يمكن للـ AI تحليل سجلات النظام (logs) وتقديم تنبؤات حول المشاكل المحتملة قبل حدوثها.
    *   **إدارة المستخدمين بالذكاء الاصطناعي**: يمكن للـ AI اقتراح مستويات وصول للمستخدمين بناءً على أدوارهم، أو اكتشاف النشاط غير الطبيعي للحسابات.
    *   **تقارير إدارية بالذكاء الاصطناعي**: يمكن للـ AI توليد تقارير ملخصة عن أداء النظام العام، أو اقتراح تحسينات في البنية التحتية.
    *   **سجل التدقيق (Audit Log)**: عرض سجل تدقيق لجميع الإجراءات الإدارية، مع إمكانية بحث وتحليل بالذكاء الاصطناعي.

#### **`app2/app/[locale]/voice/page.tsx`**
*   **تصحيح/ملاحظة**: يستخدم `motion` و `AnimatePresence` لأنيميشن ممتاز، وواجهة جيدة لمحاكاة المكالمات.
*   **أخطاء**:
    *   **الترجمة الناقصة**: الكثير من النصوص إنجليزية ثابتة (مثال: "Powered by Intelligence", "RECORDING").
    *   **اتجاه الـ icons في RTL**: استخدام `mr-2` لـ `Activity` في الـ Badge يحتاج إلى تعديل لـ RTL.
*   **تصحيح**:
    1.  استخدام `voiceT()` لجميع النصوص.
    2.  تعديل `mr-2` و `ml-2` ليتناسب مع اتجاه اللغة.
*   **تحسينات/أفكار تسويقية (تفعيل الذكاء الاصطناعي)**:
    *   **محرك صوت AI حقيقي**: استبدال محاكاة المكالمات والـ transcript بربط فعلي مع API لخدمة اتصال صوتي (مثل Twilio Voice) ودمجه مع نموذج AI لغوي متقدم (LLM) لتوليد ردود ديناميكية في الوقت الفعلي.
    *   **سيناريوهات مكالمات ديناميكية**: يمكن للـ AI توليد سيناريوهات مكالمات مخصصة لكل عميل بناءً على بيانات CRM، الحملات التي اهتم بها، وتفضيلاته.
    *   **تحليل المشاعر في الوقت الفعلي**: يمكن للـ AI تحليل نبرة صوت العميل وكلماته لتحديد مشاعره وتقديم اقتراحات فورية للموظف (أو للـ AI نفسه) لتعديل نبرة الحوار.
    *   **ملخص المكالمات ونسخها بالذكاء الاصطناعي**: بعد المكالمة، يقوم الـ AI بتلخيص المحادثة، تحديد النقاط الرئيسية، والإجراءات المطلوبة، وتسجيلها في CRM تلقائياً.
    *   **تقييم الأداء الصوتي للـ AI**: لوحة قيادة لأداء مكالمات الـ AI (معدل النجاح، متوسط المدة، رضا العميل).

#### **`app2/app/[locale]/ai-assistant/page.tsx`**
*   **تصحيح/ملاحظة**: يستخدم `PageShell` و `FloatingDots` وواجهة محادثة بسيطة.
*   **أخطاء**:
    *   **الترجمة الناقصة**: الكثير من النصوص إنجليزية ثابتة أو تستخدم الشرط اليدوي بدلاً من `t()`.
*   **تصحيح**: استخدام `t()` لجميع النصوص.
*   **تحسينات/أفكار تسويقية (تفعيل الذكاء الاصطناعي)**:
    *   **تكامل LLM حقيقي**: الربط الفعلي مع API لنموذج LLM (Gemini, GPT) عبر `app/api/ai-agent/route.ts` لتقديم ردود ذكية وحقيقية.
    *   **فهم السياق المستمر**: يجب أن يتذكر المساعد الذكي المحادثات السابقة لتقديم ردود أكثر ذكاءً وتخصيصاً.
    *   **القدرة على تنفيذ الإجراءات**: بدلاً من مجرد الإجابة على الأسئلة، يمكن للـ AI تنفيذ مهام بناءً على المحادثة (مثال: "أنشئ حملة جديدة لمشروع X"، "ابحث عن عملاء محتملين مهتمين بـ Y"، "جدولة مكالمة مع العميل Z").
    *   **عرض البيانات المرئية في المحادثة**: إذا سُئل الـ AI عن تحليلات السوق، يمكنه تضمين رسوم بيانية صغيرة أو جداول مباشرة في نافذة المحادثة.
    *   **اقتراحات استباقية**: يمكن للـ AI تقديم "إجراءات سريعة" بناءً على السياق الحالي للمستخدم أو بيانات المشروع (مثال: "يبدو أنك تراجع الحملات، هل تريد تحليل أداء الحملة X؟").
    *   **تخصيص شخصية الـ AI**: السماح للمستخدمين بتعديل نبرة الـ AI وشخصيته (رسمي، ملكي، عملي) ليناسب تفضيلاتهم.

#### **`app2/app/[locale]/campaigns-manager/page.tsx`**
*   **تصحيح/ملاحظة**: يستخدم Supabase لـ CRUD على الحملات، `PageShell`، `FloatingDots`.
*   **أخطاء**:
    *   **الترجمة الناقصة**: بعض النصوص ثابتة (مثال: `t("deleteConfirm")` لم يتم العثور على المفتاح، عنوان `PageShell`، الوصف).
*   **تصحيح**:
    1.  إضافة `deleteConfirm` إلى ملفات الـ JSON أو استخدام `t()` لجميع النصوص.
    2.  تطبيق React Hook Form و Zod للتحقق من صحة المدخلات.
*   **تحسينات/أفكار تسويقية (تفعيل الذكاء الاصطناعي)**:
    *   **تحسين الحملات بالذكاء الاصطناعي**: يمكن للـ AI تحليل أداء الحملات الجارية (من صفحة التحليلات) وتقديم توصيات لتحسين الميزانية، الجمهور المستهدف، أو تعديل الإعلانات.
    *   **تخطيط الحملات بالذكاء الاصطناعي**: يمكن للـ AI المساعدة في إنشاء حملات جديدة من الصفر، اقتراح ميزانيات بناءً على أهداف الأداء، أو تحديد الجماهير.
    *   **لوحة قيادة أداء الحملات**: إضافة لوحة قيادة صغيرة لكل حملة تعرض أهم المقاييس (الإنفاق، النقرات، التحويلات) في لمحة سريعة.
    *   **تنبيهات الحملات**: إشعارات بالذكاء الاصطناعي حول الحملات التي تتجاوز الميزانية، أو التي تحت الأداء، أو التي انتهت.
    *   **مراقبة المنافسين بالذكاء الاصطناعي**: يمكن للـ AI تتبع حملات المنافسين وتقديم رؤى للمساعدة في تعديل استراتيجيات الحملة.

#### **`app2/app/[locale]/analytics/page.tsx`**
*   **تصحيح/ملاحظة**: يستخدم `recharts` لإنشاء الرسوم البيانية.
*   **أخطاء**:
    *   **الترجمة الناقصة**: يستخدم الشرط اليدوي `isArabic ? "..." : "..."` بدلاً من `useTranslations()` أو `await getTranslations()`.
    *   **بيانات وهمية**: جميع بيانات `chartData`, `stats`, `metrics` وهمية حالياً.
    *   **مفتاح `useTranslations` غير مستورد**: المكون لا يستورد `useTranslations` (أو `getTranslations`).
*   **تصحيح**:
    1.  استيراد `useTranslations` وتهيئتها `const t = useTranslations('Analytics');`.
    2.  استخدام `t('key')` لجميع النصوص.
    3.  ربط البيانات بمصدر حقيقي عبر API (مثال: `/api/instagram/analytics/campaigns/[id]/route.ts`).
*   **تحسينات/أفكار تسويقية (تفعيل الذكاء الاصطناعي)**:
    *   **رؤى تحليلية بالذكاء الاصطناعي**: هذا هو المكان المثالي للذكاء الاصطناعي لتقديم رؤى قابلة للتنفيذ.
        *   **تفسير الرسوم البيانية**: يمكن للـ AI تحليل الرسم البياني وتقديم ملخصات نصية أو صوتية لما يعنيه الانخفاض أو الارتفاع في الأداء.
        *   **تنبؤات الأداء**: استخدام الـ AI للتنبؤ بالأداء المستقبلي للحملة.
        *   **توصيات التحسين**: بناءً على التحليل، يقدم الـ AI توصيات محددة لتحسين الحملات (مثال: "انخفاض معدل التحويل يشير إلى أن الجمهور المستهدف غير مناسب. جرب الجمهور X").
        *   **تحديد الشذوذ (Anomaly Detection)**: تنبيهات تلقائية من الـ AI عند اكتشاف سلوك غير عادي في البيانات (مثل ارتفاع مفاجئ في الإنفاق بدون زيادة في التحويلات).
    *   **لوحات تحكم قابلة للتخصيص**: السماح للمستخدمين بتحديد المقاييس والرسوم البيانية التي يرغبون في رؤيتها.
    *   **تصفية وتحليل متقدم**: إضافة فلاتر لتاريخ الحملة، الجمهور، نوع الإعلان، وغيرها.
    *   **مقارنة الأداء**: مقارنة أداء الحملات الحالية بالحملات السابقة أو بمعايير الصناعة.

#### **`app2/app/api/leads/route.ts`**
*   **تصحيح/ملاحظة**: سليم لإضافة العملاء المحتملين إلى Supabase.
*   **أخطاء**: `score` يتم توليده عشوائياً.
*   **تصحيح**:
    1.  دمج `zod` للتحقق من صحة المدخلات.
    2.  **AI Lead Scoring**: بدلاً من `Math.random()`، يجب أن يقوم الـ AI بتحليل بيانات العميل المحتمل وتعيين نقاط تقييم أكثر دقة (مثال: عبر استدعاء AI Agent داخلياً).

#### **`app2/app/api/voice/route.ts`**
*   **تصحيح/ملاحظة**: يحاكي مكالمة صوتية باستخدام Illyvoip.
*   **أخطاء**: `process.env.ILLYVOIP_API_KEY || "mock-key"` - هذا يحتاج إلى مفتاح API حقيقي ليعمل.
*   **تصحيح**:
    1.  توفير مفتاح API حقيقي لـ Illyvoip.
    2.  تحسين الـ `catch(() => null)` ليشمل تسجيل الأخطاء بشكل مفصل بدلاً من إخفائها.
*   **تحسينات/أفكار تسويقية (تفعيل الذكاء الاصطناعي)**:
    *   **نصوص مكالمات ديناميكية بالذكاء الاصطناعي**: يمكن للـ AI توليد النص (`text`) بشكل ديناميكي بناءً على `campaign`، `name`، وربما بيانات إضافية للعميل من CRM.
    *   **تحليل المشاعر**: يمكن لـ Illyvoip أو أي خدمة صوتية أخرى توفير تحليل مشاعر يمكن للـ AI استغلاله لتعديل سيناريو المكالمة.
    *   **تسجيل المكالمات وتحليلها**: بعد انتهاء المكالمة، يمكن للـ AI تحليل التسجيل الصوتي وتحديد نقاط الاهتمام، تلخيص المكالمة، وتحديث حالة العميل في CRM.

#### **`app2/app/api/users/route.ts`**
*   **أخطاء**: هذا الـ API ينشئ مستخدمين في جدول يسمى `users`. في Supabase، `auth.users` هو جدول المستخدمين الفعلي للمصادقة. إذا كان الهدف هو تسجيل المستخدمين، يجب استخدام `supabase.auth.signUp()`. إذا كان لملفات شخصية للمستخدمين، يجب أن يكون الجدول يسمى `profiles` ومرتبط بـ `auth.users` عبر `user_id`.
*   **تصحيح**: تحديد الغرض من هذا الـ API وتعديله ليتوافق مع هيكل Supabase للمصادقة/البروفايلات.

#### **`app2/app/api/campaigns/route.ts`**
*   **أخطاء**: يستخدم جدول `campaigns`. هذا يتضارب مع `InstagramCampaign` المستخدم في الـ API الخاص بـ Instagram.
*   **تصحيح**: توحيد أسماء الجداول واستخدام جدول واحد للحملات.

#### **`app2/app/api/ai-agent/route.ts`**
*   **ملاحظة جوهرية (تطوير الذكاء الاصطناعي)**: هذا هو الـ Backend لـ AI Agent، ويحتوي على منطق AI وهمي حالياً.
*   **أخطاء**:
    *   `ZAI from "z-ai-web-dev-sdk"` معطل: يشير إلى أن الـ SDK الفعلي غير مستخدم.
    *   `PREMIUM_LEADS` في الذاكرة: ستفقد البيانات عند إعادة تشغيل الخادم. يجب أن تكون مستمرة في قاعدة البيانات (Supabase/Prisma).
*   **تصحيح**:
    1.  **تفعيل ZAI SDK**: ربط `EmperorAI.command` بالـ SDK الحقيقي أو مباشرة بـ Gemini/GPT API.
    2.  **تخزين `PREMIUM_LEADS` بشكل دائم**: استبدال المصفوفة في الذاكرة بعمليات `prisma` أو `supabase` لقراءة وكتابة البيانات.
    3.  **الربط بـ `/api/voice`**: يجب أن يقوم `ImperialVoiceEngine.initiateRoyalCall` باستدعاء `/api/voice` الفعلي وليس مجرد محاكاة.
*   **تحسينات/أفكار تسويقية (تفعيل الذكاء الاصطناعي)**:
    *   **شخصية الـ AI المتقدمة**: `IMPERIUM_AI.persona` و `knowledge` ممتازة جداً كنقاط بداية لتعليم الـ AI. يمكن استخدامها كجزء من الـ prompt للـ LLM لضمان استجابات متسقة مع العلامة التجارية.
    *   **دمج الوظائف (Function Calling)**: يمكن للـ AI Agent استخدام "function calling" للتفاعل مع APIs الأخرى (مثل CRM، Campaign Manager، Analytics) لجمع المعلومات أو تنفيذ الإجراءات بناءً على طلبات المستخدم.
    *   **قاعدة المعرفة الديناميكية**: يمكن تطوير واجهة إدارية تسمح بتحديث `IMPERIUM_AI.knowledge` بشكل ديناميكي (مثل إضافة مشاريع عقارية جديدة، قواعد ذهبية).
    *   **تحليل السوق بالذكاء الاصطناعي**: يمكن للـ AI تحليل بيانات السوق الحقيقية وتقديم توصيات استثمارية حقيقية بدلاً من النص الثابت.

#### **`app2/app/api/instagram/ads/route.ts` & `app2/app/api/instagram/ads/[id]/route.ts`**
*   **تصحيح/ملاحظة**: APIs لـ CRUD على الإعلانات.
*   **أخطاء**: `InstagramAd` هو اسم الجدول، لكن `app/api/campaigns/route.ts` يستخدم `campaigns`. يجب توحيد الأسماء.
*   **تحسينات**:
    *   **التحقق من الصلاحيات (Authorization)**: يجب التحقق من أن المستخدم المصرح له فقط يمكنه الوصول أو تعديل الإعلانات.
    *   **التحقق من صحة المدخلات (Validation)**: استخدام `zod` للتحقق من صحة جسم الطلب.

#### **`app2/app/api/instagram/campaigns/route.ts` & `app2/app/api/instagram/campaigns/[id]/route.ts`**
*   **تصحيح/ملاحظة**: APIs لـ CRUD على الحملات.
*   **أخطاء**: `InstagramCampaign` هو اسم الجدول. يتضارب مع `app/api/campaigns/route.ts`.
*   **تحسينات**:
    *   **التحقق من الصلاحيات (Authorization)**.
    *   **التحقق من صحة المدخلات (Validation)**.

#### **`app2/app/api/instagram/assets/upload/route.ts`**
*   **تصحيح/ملاحظة**: API لرفع الأصول مع التحقق من الحجم والنوع.
*   **تحسينات**:
    *   **التحقق من الصلاحيات**: التأكد من أن المستخدم يرفع الأصول لحملاته الخاصة فقط.
    *   **معالجة الأصول بالذكاء الاصطناعي**:
        *   **توليد صور مصغرة (Thumbnails)**: توليد صور مصغرة حقيقية على الخادم (مثال: باستخدام `sharp`) بدلاً من استخدام نفس رابط الأصل.
        *   **التعرف على المحتوى**: يمكن للـ AI تحليل محتوى الصورة/الفيديو وتوليد `altText` تلقائياً أو اقتراح كلمات مفتاحية.
        *   **تحسين الأصول**: يمكن للـ AI اقتراح تحسينات على الأصول (القص، الألوان، الجودة) لزيادة فعاليتها الإعلانية.
    *   **استخراج البيانات الوصفية (Metadata Extraction)**: استخراج الأبعاد الحقيقية للصور والمدة الحقيقية للفيديوهات بدلاً من القيم الثابتة/العشوائية.

#### **`app2/app/api/instagram/analytics/campaigns/[id]/route.ts`**
*   **تصحيح/ملاحظة**: API لجلب تحليلات الحملات من Supabase.
*   **تحسينات**:
    *   **التخزين المؤقت (Caching)**: يمكن تطبيق التخزين المؤقت لبيانات التحليلات لتحسين الأداء.
    *   **التحليل الزمني المرن**: إضافة خيارات لتحديد النطاق الزمني بشكل أكثر مرونة (شهري، ربع سنوي، نطاق مخصص).
    *   **مقاييس متقدمة**: حساب مقاييس تسويقية متقدمة مثل ROAS (Return On Ad Spend) إذا كانت البيانات متاحة.
    *   **اكتشاف الشذوذ بالذكاء الاصطناعي**: يمكن للـ AI تحليل هذه البيانات لاكتشاف أي شذوذ في الأداء (ارتفاع غير متوقع، انخفاض حاد) وإرسال تنبيهات.

---

## ملخص الأخطاء الحرجة والإجراءات الفورية:

1.  **تصحيح إصدارات التكنولوجيا**:
    *   **Tailwind CSS**: في `package.json` و `app/globals.css`، **يجب** العودة إلى `^3.x.x`.
    *   **Next.js & React**: في `package.json`، **يجب** العودة إلى إصدارات مستقرة (Next.js `^14.x.x`، React `^18.x.x`).
2.  **حل تضارب الملفات**:
    *   **حذف**: `app2/next-i18next.config.js`، `app2/vite.config.ts`.
    *   **توحيد**: `app2/app/dashboard/page.tsx` (اختر نسخة `[locale]` Server-side).
    *   **توحيد**: `app2/app/login/page.tsx` (اختر نسخة `[locale]` مع Supabase).
    *   **توحيد**: ملفات `language-switcher.tsx` (اختر النسخة التي تستخدم `router.push`).
3.  **توحيد أسماء الجداول**: حل التضارب بين `campaigns` و `InstagramCampaign`، و `users` و `profiles`.
4.  **الأمان**: إعادة هيكلة `lib/supabase.ts` لعدم تصدير `supabaseAdmin` بشكل عام.
5.  **الترجمة الكاملة**: استخدام `t()` و `await getTranslations()` بشكل منهجي في جميع المكونات التي تعرض نصوصاً للمستخدم، وتجنب الشرط اليدوي `locale === "ar" ? "..." : "..."`.
6.  **`use-toast.ts`**: تقليل `TOAST_REMOVE_DELAY` إلى قيمة معقولة.

---

## أفكار تسويقية واستراتيجيات تطوير بالذكاء الاصطناعي:

بصفتي متخصصًا في تسويق الذكاء الاصطناعي، يمتلك هذا المشروع إمكانات هائلة ليصبح مركز قيادة حقيقياً للعقارات الفاخرة. لتحقيق ذلك، يجب تحويل "الذكاء الاصطناعي المحاكى" إلى "ذكاء اصطناعي عامل" يضيف قيمة حقيقية للمسوقين:

1.  **منشئ الإعلانات الذكي (AI Ad Creator)**:
    *   **توليد أفكار إعلانية**: AI يقترح رؤوس أقلام (Headlines)، أوصاف (Descriptions)، وعبارات تحفيزية (CTAs) بناءً على تحليل السوق، أداء الحملات السابقة، والجمهور المستهدف.
    *   **تخصيص الإعلانات**: يولد AI نسخاً مختلفة من الإعلان لكل منصة (Instagram Stories, Reels, Feed) لتحقيق أقصى وصول وتأثير.
    *   **تحسين الأصول المرئية**: AI يقترح قصات مثالية للصور، تعديلات الألوان، أو حتى يولد صوراً/فيديوهات بسيطة متوافقة مع الرسالة التسويقية.
    *   **تصنيف الأصول**: AI يقوم بتصنيف الوسائط تلقائياً (مثال: "صور فلل"، "فيديوهات شاطئية") لتسهيل الوصول إليها.

2.  **نظام CRM الذكي (AI-Powered CRM)**:
    *   **تقييم العملاء المحتملين (Lead Scoring)**: AI يحلل بيانات العملاء المحتملين (المصدر، التفاعلات، الميزانية المقترحة) ويمنحهم درجة "جودة العميل" لتحديد أولويات المتابعة.
    *   **أتمتة المتابعة**: AI يرسل رسائل بريد إلكتروني أو رسائل نصية مخصصة للعملاء بناءً على سلوكهم ونقاط تقييمهم.
    *   **ملخصات العملاء**: AI يلخص التفاعلات السابقة مع العميل (مكالمات، رسائل) ويقدم رؤى سريعة للمسوق قبل أي تواصل.
    *   **تحديد أفضل وقت للتواصل**: AI يقترح أفضل وقت ومناسبة للتواصل مع كل عميل لزيادة فرص التحويل.

3.  **مساعد الإمبراطورية الذكي (IMPERIUM AI Assistant)**:
    *   **فهم سياقي عميق**: المساعد يفهم المحادثات السابقة، بيانات CRM، وأداء الحملات لتقديم إجابات أكثر دقة وتخصيصاً.
    *   **تنفيذ المهام الصوتية/النصية**: يمكن للمساعد تنفيذ أوامر مثل "أنشئ حملة جديدة لمشروع X"، "ابحث عن عميل Y"، أو "أرسل تقريراً عن أداء الحملة Z".
    *   **تقديم رؤى مرئية**: عندما يطلب المستخدم بيانات أو تحليلات، يعرض المساعد رسوماً بيانية وجداول صغيرة داخل نافذة المحادثة.
    *   **تنبيهات استباقية**: المساعد يقدم تنبيهات تلقائية حول فرص جديدة أو مشاكل محتملة (مثال: "لاحظت ارتفاعاً في الاهتمام بمشروع Y. هل تريد إطلاق حملة سريعة؟").

4.  **مركز الاتصال الصوتي الذكي (AI Voice Center)**:
    *   **وكلاء صوتيين بالذكاء الاصطناعي**: AI يتولى المكالمات الأولية مع العملاء، يقدم معلومات عن العقارات، ويحدد الاهتمامات.
    *   **تحليل المشاعر**: AI يحلل نبرة صوت العميل ومشاعره خلال المكالمة لتكييف أسلوب الحوار.
    *   **ملخصات المكالمات**: AI يلخص المكالمات، يحدد النقاط الرئيسية، ويسجلها تلقائياً في CRM.
    *   **مساعدة الوكلاء البشريين**: AI يقدم للوكلاء البشريين نصوصاً مقترحة وإجابات في الوقت الفعلي خلال المكالمات.

5.  **لوحة التحكم والتحليلات بالذكاء الاصطناعي (AI Analytics & Dashboard)**:
    *   **رؤى تحليلية قابلة للتنفيذ**: AI لا يكتفي بعرض الرسوم البيانية، بل يفسرها ويقدم توصيات محددة (مثال: "انخفاض معدل التحويل يشير إلى أن الجمهور المستهدف غير مناسب. جرب الجمهور X").
    *   **تنبؤات الأداء**: AI يتنبأ بأداء الحملات المستقبلية، الإنفاق، والتحويلات.
    *   **تحديد الشذوذ (Anomaly Detection)**: AI يكتشف الأنماط غير العادية في البيانات وينبه المستخدم (مثال: "ارتفاع مفاجئ في الإنفاق بدون زيادة في النقرات").
    *   **تخصيص لوحات التحكم**: AI يقدم لوحات تحكم مخصصة لكل مستخدم بناءً على أهمية المقاييس لدوره.

6.  **تحسين تجربة المستخدم (UI/UX)**:
    *   **رسائل تحميل ذكية**: بدلاً من "Loading..."، يمكن للـ AI أن يعرض رسائل تحميل مثل "جاري تحليل بيانات السوق الأخيرة..." أو "جاري توليد أفضل استراتيجية لعميلك...".
    *   **تخصيص الواجهة**: يمكن للـ AI تعديل بعض جوانب الواجهة لتناسب تفضيلات المستخدم (مثال: تخطيط لوحة التحكم، الألوان المفضلة).

بتطبيق هذه التصحيحات والأفكار التطويرية، سيتحول "Imperium Gate" إلى منصة قوية وذكية حقاً، تليق بلقب "بوابة الإمبراطورية" في عالم تسويق العقارات الفاخرة المدعوم بالذكاء الاصطناعي.




## خطة عمل لتصحيح وتطوير IMPERIUM GATE

### المرحلة الأولى: تصحيحات حرجة واستقرار النظام

1.  **تحديث التبعيات إلى إصدارات مستقرة:**
    *   تعديل `package.json` لـ `next`, `react`, `react-dom`, `tailwindcss`, `next-intl` إلى أحدث الإصدارات المستقرة (Next.js v14, React v18, Tailwind CSS v3).
    *   إزالة `nodemon` و `tw-animate-css` (إذا كان `tailwindcss-animate` يغطي الحاجة).
    *   توحيد إصدار `next-intl` بين `package.json` و `index.html`.
    *   تحديث `typescript` إلى أحدث إصدار مستقر.
2.  **تنظيف ملفات الإعدادات المتضاربة:**
    *   حذف `app2/next-i18next.config.js` (تضارب مع `next-intl`).
    *   حذف `app2/vite.config.ts` (تضارب مع Next.js).
3.  **توحيد مسارات الصفحات:**
    *   حذف `app2/app/dashboard/page.tsx` و `app2/app/login/page.tsx` حيث توجد نسخ مترجمة أفضل في `app2/app/[locale]/`.
    *   توحيد مكون `LanguageSwitcher` إلى نسخة واحدة فقط.
4.  **تصحيح `globals.css` لـ Tailwind CSS v3:**
    *   إزالة `@custom-variant dark (&:is(.dark *));`.
    *   التأكد من أن جميع الـ utilities المخصصة تعمل بشكل صحيح مع v3.
5.  **تحسين الأمان في `lib/supabase.ts`:**
    *   تعديل `supabaseAdmin` ليتم استدعاؤه كدالة فقط عند الحاجة في سياق الـ Server Side لضمان عدم تسرب المفتاح.
6.  **معالجة مشكلات الترجمة:**
    *   تعديل جميع النصوص الثابتة في الـ components لتستخدم `t()` و `useTranslations()` أو `getTranslations()` بشكل صحيح.
    *   تحديث ملفات `messages/en.json` و `messages/ar.json` لإضافة المفاتيح الناقصة.
    *   تصحيح استخدام `await getTranslations({ locale });` في الـ Server Components.
7.  **تصحيح `use-toast.ts`:**
    *   تقليل `TOAST_REMOVE_DELAY` إلى قيمة معقولة (مثلاً 5 ثوانٍ).
8.  **تخصيص الشريط الجانبي (Sidebar) لـ RTL:**
    *   تعديل منطق الاتجاه في `app-sidebar.tsx` و `app/[locale]/layout.tsx` ليناسب `rtl` (يفتح من اليسار، الأيقونات).

### المرحلة الثانية: تفعيل الذكاء الاصطناعي ودمج البيانات الحقيقية

1.  **تفعيل محاكاة الذكاء الاصطناعي إلى AI حقيقي (مفاهيمياً):**
    *   في `lib/ai-suggestions.ts` و `app/api/ai-agent/route.ts`، استبدال المنطق الوهمي بمنطق يستدعي API لنموذج لغوي كبير (LLM) مثل Gemini أو OpenAI GPT. (سنستخدم `console.log` وردود وهمية أكثر تعقيدًا كممثل للـ API الفعلي).
    *   إضافة القدرة على تنفيذ "Function Calling" في `ai-agent` للتفاعل مع الـ APIs الأخرى (CRM, Campaigns).
2.  **دمج البيانات مع Prisma/Supabase:**
    *   في `app/api/ai-agent/route.ts`، استبدال `PREMIUM_LEADS` في الذاكرة بعمليات Prisma/Supabase.
    *   تفعيل وظيفة التعديل (`Edit Lead`) في `CRMPage`.
    *   ربط إعدادات `SettingsPage` بـ Supabase.
3.  **التحقق من صحة المدخلات (Validation):**
    *   إضافة `zod` مع React Hook Form لـ `CRMPage` و `AdCreatorContent` و `CampaignsManagerPage` و `SettingsPage` لضمان صحة البيانات.
4.  **تحسين تجربة المستخدم (UX):**
    *   إضافة لوحات "Coming soon..." إلى الصفحات التي لم يتم تطويرها بعد بشكل كامل في Admin Dashboard.
    *   تحسين رسائل التحميل لتكون أكثر توضيحاً وديناميكية.

---

## الأكواد المصححة (الأكواد الأساسية التي تحتاج تعديلاً كبيراً)

سأقدم الأكواد الأساسية التي تحتاج تعديلات جذرية أو حرجة. أما مكونات Shadcn/ui فمعظمها صحيح بنيوياً ما لم يذكر خلاف ذلك، وسأركز على تصحيح استخدامها في الصفحات.

**ملاحظة هامة:** بما أننا لا نملك مفتاح API لـ LLM حقيقي، فإن جزء "تفعيل الذكاء الاصطناعي" في الـ APIs سيبقى ممثلاً بمنطق `console.log` أو ردود وهمية متقدمة، مع الإشارة إلى مكان التكامل الحقيقي.

---

### 1. `package.json` (تم التحديث إلى إصدارات مستقرة)

```json
{
  "name": "nextjs_tailwind_shadcn_ts",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev -p 8080",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "db:push": "prisma db push",
    "db:generate": "prisma generate",
    "db:migrate": "prisma migrate dev",
    "db:reset": "prisma migrate reset",
    "db:studio": "prisma studio"
  },
  "dependencies": {
    "@dnd-kit/core": "^6.3.1",
    "@dnd-kit/sortable": "^10.0.0",
    "@dnd-kit/utilities": "^3.2.2",
    "@hookform/resolvers": "^3.9.0",
    "@mdxeditor/editor": "^3.39.1",
    "@prisma/client": "^5.17.0",
    "@radix-ui/react-accordion": "^1.2.11",
    "@radix-ui/react-alert-dialog": "^1.1.14",
    "@radix-ui/react-aspect-ratio": "^1.1.7",
    "@radix-ui/react-avatar": "^1.1.10",
    "@radix-ui/react-checkbox": "^1.3.2",
    "@radix-ui/react-collapsible": "^1.1.11",
    "@radix-ui/react-context-menu": "^2.2.15",
    "@radix-ui/react-dialog": "^1.1.14",
    "@radix-ui/react-dropdown-menu": "^2.1.15",
    "@radix-ui/react-hover-card": "^1.1.14",
    "@radix-ui/react-label": "^2.1.7",
    "@radix-ui/react-menubar": "^1.1.15",
    "@radix-ui/react-navigation-menu": "^1.2.13",
    "@radix-ui/react-popover": "^1.1.14",
    "@radix-ui/react-progress": "^1.1.7",
    "@radix-ui/react-radio-group": "^1.3.7",
    "@radix-ui/react-scroll-area": "^1.2.9",
    "@radix-ui/react-select": "^2.2.5",
    "@radix-ui/react-separator": "^1.1.7",
    "@radix-ui/react-slider": "^1.3.5",
    "@radix-ui/react-slot": "^1.2.3",
    "@radix-ui/react-switch": "^1.2.5",
    "@radix-ui/react-tabs": "^1.1.12",
    "@radix-ui/react-toast": "^1.2.14",
    "@radix-ui/react-toggle": "^1.1.9",
    "@radix-ui/react-toggle-group": "^1.1.10",
    "@radix-ui/react-tooltip": "^1.2.7",
    "@reactuses/core": "^6.0.5",
    "@supabase/ssr": "^0.7.0",
    "@supabase/supabase-js": "^2.47.0",
    "@tanstack/react-query": "^5.82.0",
    "@tanstack/react-table": "^8.21.3",
    "axios": "^1.10.0",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cmdk": "^1.1.1",
    "date-fns": "^3.6.0",
    "embla-carousel-react": "^8.6.0",
    "framer-motion": "^11.3.17",
    "input-otp": "^1.4.2",
    "lucide-react": "^0.395.0",
    "next": "14.2.5",
    "next-auth": "^4.24.11",
    "next-intl": "^4.5.5",
    "next-themes": "^0.3.0",
    "prisma": "^5.17.0",
    "react": "18.3.1",
    "react-day-picker": "^8.10.1",
    "react-dom": "18.3.1",
    "react-hook-form": "^7.52.1",
    "react-markdown": "^9.0.1",
    "react-resizable-panels": "^3.0.3",
    "react-syntax-highlighter": "^15.6.1",
    "recharts": "^2.15.4",
    "sharp": "^0.33.4",
    "sonner": "^1.5.0",
    "tailwind-merge": "^2.4.0",
    "tailwindcss-animate": "^1.0.7",
    "tsx": "^4.20.3",
    "uuid": "^11.1.0",
    "vaul": "^1.1.2",
    "z-ai-web-dev-sdk": "^0.0.10",
    "zod": "^3.23.8",
    "zustand": "^4.5.4"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3",
    "@tailwindcss/postcss": "^4.0.0-rc.3",
    "@types/node": "^20",
    "@types/react": "^18.3.3",
    "@types/react-dom": "^18.3.0",
    "eslint": "^9",
    "eslint-config-next": "14.2.5",
    "postcss": "^8.4.39",
    "tailwindcss": "^3.4.6",
    "typescript": "^5"
  }
}
```

---

### 2. حذف الملفات غير الضرورية/المتضاربة

*   **`app2/next-i18next.config.js`**: **احذف هذا الملف**.
*   **`app2/vite.config.ts`**: **احذف هذا الملف**.
*   **`app2/app/dashboard/page.tsx`**: **احذف هذا الملف**.
*   **`app2/app/login/page.tsx`**: **احذف هذا الملف**.

---

### 3. `app2/app/layout.tsx` (Root Layout)

*   **ملاحظة**: يجب أن يكون هذا الملف بسيطًا قدر الإمكان ويحتوي فقط على ما لا يمكن وضعه في `[locale]/layout.tsx`.
*   **التعديل**: تم إزالة `lang` و `dir` من `html` tag ليتم التحكم بها في `[locale]/layout.tsx`.

```tsx
// FILE: app2/app/layout.tsx
// Replaced with correct imports for Geist fonts from the 'geist' package
import { GeistSans } from 'geist/font/sans';
import { GeistMono } from 'geist/font/mono';
import "./globals.css";
import { Toaster } from "@/components/ui/toaster"; // Shadcn Toaster

const geistSans = GeistSans;
const geistMono = GeistMono;

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    // Removed lang="en" and dir="ltr" as they will be set in [locale]/layout.tsx
    // suppressHydrationWarning is kept for themeing solutions like next-themes
    <html className={`${geistSans.variable} ${geistMono.variable}`} suppressHydrationWarning>
      <body>
        {children}
        {/* Shadcn Toaster will listen to toast events from useToast hook */}
        <Toaster />
      </body>
    </html>
  );
}
```

---

### 4. `app2/app/globals.css` (متوافق مع Tailwind CSS v3)

*   **التعديل**: إزالة `tw-animate-css` إذا كان `tailwindcss-animate` كافياً. إزالة `custom-variant` الذي كان خاصاً بـ Tailwind v4.

```css
/* FILE: app2/app/globals.css */
@import "tailwindcss/base";
@import "tailwindcss/components";
@import "tailwindcss/utilities";

/* Remove @custom-variant for Tailwind CSS v3 compatibility */

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans), ui-sans-serif, system-ui;
  --font-mono: var(--font-geist-mono), ui-monospace, monospace;
  --color-sidebar-ring: var(--sidebar-ring);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar: var(--sidebar);
  --color-chart-5: var(--chart-5);
  --color-chart-4: var(--chart-4);
  --color-chart-3: var(--chart-3);
  --color-chart-2: var(--chart-2);
  --color-chart-1: var(--chart-1);
  --color-ring: var(--ring);
  --color-input: var(--input);
  --color-border: var(--border);
  --color-destructive: var(--destructive);
  --color-accent-foreground: var(--accent-foreground);
  --color-accent: var(--accent);
  --color-muted-foreground: var(--muted-foreground);
  --color-muted: var(--muted);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-secondary: var(--secondary);
  --color-primary-foreground: var(--primary-foreground);
  --color-primary: var(--primary);
  --color-popover-foreground: var(--popover-foreground);
  --color-popover: var(--popover);
  --color-card-foreground: var(--card-foreground);
  --color-card: var(--card);
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);
}

/* ========================== IMPERIUM ROYAL PALETTE (Gold & Dark Theme) ========================== */
:root {
  --radius: 1rem;
  --background: #030714;
  --foreground: #f5f7ff;
  --panel: rgba(14, 18, 36, 0.9);
  --panel-foreground: #ffffff;
  --panel-soft: rgba(17, 24, 39, 0.95);
  --border-soft: rgba(255, 255, 255, 0.12);
  --primary: #D4AF37;
  --primary-dark: #AA8C2C;
  --primary-light: #E5C158;
  --muted: #bfc5d9;
  --secondary: #0f172a;
  --accent-teal: #2dd4bf;
  --destructive: #f97316;
  --ring: rgba(212, 175, 55, 0.4);
  --sidebar: #060a1a;
  --sidebar-foreground: #f6f8ff;
  --sidebar-primary: #D4AF37;
  --sidebar-primary-active: rgba(212, 175, 55, 0.2);
  --sidebar-border: rgba(212, 175, 55, 0.15);
  --chart-1: #D4AF37;
  --chart-2: #E5C158;
  --chart-3: #AA8C2C;
  --chart-4: #ea580c;
  --chart-5: #38bdf8;
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --color-card: var(--panel);
  --color-card-foreground: var(--panel-foreground);
  --color-popover: var(--panel);
  --color-popover-foreground: var(--panel-foreground);
  --color-sidebar: var(--sidebar);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-border: var(--border-soft);
  --color-input: rgba(255, 255, 255, 0.08);
  --color-ring: var(--ring);
  --color-primary: var(--primary);
  --color-primary-foreground: #030714;
  --color-secondary: var(--secondary);
  --color-secondary-foreground: #eef2ff;
  --color-muted: var(--muted);
  --color-muted-foreground: #b0b5c3;
  --color-destructive: var(--destructive);
}

/* Updated dark mode selector for Tailwind v3 compatibility, if not using next-themes custom dark class */
html.dark,
.dark { /* Added .dark for compatibility if dark mode is toggled via class */
  --background: #01030b;
  --foreground: #f2f5ff;
  --panel: rgba(13, 17, 37, 0.92);
  --panel-soft: rgba(9, 12, 28, 0.95);
  --border-soft: rgba(212, 175, 55, 0.1);
  --sidebar: #040810;
  --sidebar-border: rgba(212, 175, 55, 0.12);
  --sidebar-primary-active: rgba(212, 175, 55, 0.25);
  --primary-dark: #B8960D;
  --color-muted-foreground: #9ca3af;
}

/* ========================== Base Layer – كل حاجة بتطلع فخمة ========================== */
@layer base {
  * {
    @apply border-border outline-none;
    outline-color: transparent;
    outline-offset: 2px;
  }

  *:focus-visible {
    @apply ring-4 ring-ring/30;
  }

  body {
    @apply bg-background text-foreground antialiased font-sans;
    font-feature-settings: "rlig" 1, "calt" 1, "liga" 1;
    letter-spacing: 0.3px;
  }

  h1, h2, h3, h4, h5, h6 {
    @apply font-sans font-semibold;
    letter-spacing: -0.5px;
  }

  h1 {
    @apply text-3xl;
    font-weight: 700;
  }

  h2 {
    @apply text-2xl;
    font-weight: 600;
  }

  h3 {
    @apply text-xl;
    font-weight: 600;
  }

  p {
    @apply font-sans;
    line-height: 1.6;
  }

  /* Scrollbar فاخرة */
  ::-webkit-scrollbar {
    width: 8px;
  }
  ::-webkit-scrollbar-track {
    @apply bg-transparent;
  }
  ::-webkit-scrollbar-thumb {
    @apply bg-primary/30 rounded-full border-2 border-background;
  }
  ::-webkit-scrollbar-thumb:hover {
    @apply bg-primary/50;
  }
}

/* ========================== Custom Utilities ========================== */
@layer utilities {
  /* Gradient Text - Imperium Royal Gold */
  .text-gradient-gold {
    background-image: linear-gradient(135deg, #E5C158, #D4AF37);
    background-clip: text;
    color: transparent;
  }

  /* Glass Effect */
  .glass {
    background: rgba(14, 18, 36, 0.7);
    backdrop-filter: blur(32px);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 20px;
    box-shadow: 0 30px 45px rgba(0, 0, 0, 0.6);
  }

  /* Luxury Card Hover */
  .card-hover {
    @apply transition-all duration-500 ease-out hover:-translate-y-2 hover:shadow-[0_25px_45px_rgba(0,0,0,0.6)] hover:border-primary;
  }

  .btn-primary {
    @apply inline-flex items-center justify-center gap-2 rounded-full px-6 py-3 font-semibold text-sm uppercase tracking-[0.2em] text-gray-900 transition-all duration-300;
    background: linear-gradient(135deg, #D4AF37, #AA8C2C);
    box-shadow: 0 12px 30px rgba(212, 175, 55, 0.35);
    border: 1px solid rgba(212, 175, 55, 0.2);
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #E5C158, #D4AF37);
    box-shadow: 0 16px 40px rgba(212, 175, 55, 0.5);
    transform: translateY(-2px);
  }

  .btn-outline {
    @apply inline-flex items-center justify-center gap-2 rounded-full px-6 py-3 text-sm uppercase tracking-[0.2em] border border-neutral-500 text-neutral-200 transition-colors duration-300;
    background: transparent;
  }

  .card-panel {
    background: rgba(14, 18, 36, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 24px;
    padding: 32px;
    box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
  }

  .input-glass {
    width: 100%;
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    background: rgba(17, 24, 39, 0.8);
    padding: 12px 16px;
    font-size: 16px;
    color: #f5f5f5;
    backdrop-filter: blur(20px);
  }

  .input-glass::placeholder {
    color: #6b7280;
  }

  .input-glass:focus {
    border-color: #D4AF37;
    outline: none;
    box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.4);
  }

  .page-shell {
    @apply w-full max-w-6xl mx-auto py-10 px-4 lg:px-0;
  }

  .section-title {
    @apply text-3xl font-semibold tracking-tight mb-2;
  }

  .body-muted {
    @apply text-sm text-muted-foreground;
  }

  .divider-glow {
    height: 2px;
    width: 96px;
    border-radius: 9999px;
    background: linear-gradient(to right, #D4AF37, #B8960D);
    margin-top: 16px;
    margin-bottom: 24px;
    box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
  }
}
```

---

### 5. `app2/lib/supabase.ts` (معالجة الأمان لـ `supabaseAdmin`)

*   **التعديل**: تم تغيير `supabaseAdmin` ليصبح دالة `createAdminClient` يتم استدعاؤها فقط عند الحاجة في الـ Server-side، بدلاً من تصدير `supabaseAdmin` ككائن جاهز. هذا يقلل من خطر التعرض.

```typescript
// FILE: app2/lib/supabase.ts
import { createBrowserClient, createServerClient } from '@supabase/ssr';
import { ReadonlyRequestCookies } from 'next/dist/server/web/spec-extension/adapters/request-cookies';

// Validate required environment variables
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;
// SUPABASE_SERVICE_ROLE_KEY should NEVER be exposed to the client
const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseAnonKey) {
    throw new Error('Missing required Supabase environment variables: NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY');
}

/**
 * Supabase client for client-side operations (or server-side with RLS for current user)
 * - Respects Row Level Security (RLS) policies
 * - Persists session in localStorage (browser only)
 * - Auto-refreshes expired tokens
 */
export const supabase = createBrowserClient(supabaseUrl, supabaseAnonKey);

/**
 * Creates a Supabase admin client for server-side operations (API routes, server components).
 * ⚠️ WARNING: This client bypasses RLS policies using SERVICE_ROLE_KEY.
 * - ONLY use on the server side
 * - NEVER expose this to the client
 * - Use only when administrative access is explicitly required
 * - Audit all operations performed with this client
 *
 * @param cookies - Optional: Next.js cookies object for SSR context (e.g., from `headers().get('cookie')`)
 */
export function createAdminClient(cookies?: ReadonlyRequestCookies) {
    if (!serviceRoleKey) {
        console.warn('SUPABASE_SERVICE_ROLE_KEY not found. Admin operations will use standard client with RLS.');
        // Fallback to client-side supabase if service role key is missing
        return supabase;
    }

    return createServerClient(supabaseUrl, serviceRoleKey, {
        cookies: {
            getAll() {
                // If in an SSR context (e.g., Middleware, Server Component), cookies will be passed.
                // Otherwise, it's a server API route without direct request cookies, so return empty.
                if (cookies) {
                    return cookies.getAll();
                }
                return [];
            },
            setAll(cookiesToSet) {
                // In a server environment, you'd typically set cookies on the response.
                // For simplicity in this common function, this part is left as-is,
                // but in Next.js Server Actions/API routes, you'd use `cookies().set()`.
                // This might not be fully functional for server-side cookie setting if `cookies` from Next.js is not available in context.
            },
        },
    });
}
```

---

### 6. `app2/hooks/use-toast.ts` (تصحيح مدة التوست)

*   **التعديل**: تقليل `TOAST_REMOVE_DELAY` إلى 5 ثوانٍ.

```typescript
// FILE: app2/hooks/use-toast.ts
"use client"

// Inspired by react-hot-toast library
import * as React from "react"

import type {
  ToastActionElement,
  ToastProps,
} from "@/components/ui/toast"

const TOAST_LIMIT = 1
const TOAST_REMOVE_DELAY = 5000 // Corrected: 5 seconds (5000ms) instead of 1 million ms

type ToasterToast = ToastProps & {
  id: string
  title?: React.ReactNode
  description?: React.ReactNode
  action?: ToastActionElement
}

const actionTypes = {
  ADD_TOAST: "ADD_TOAST",
  UPDATE_TOAST: "UPDATE_TOAST",
  DISMISS_TOAST: "DISMISS_TOAST",
  REMOVE_TOAST: "REMOVE_TOAST",
} as const

let count = 0

function genId() {
  count = (count + 1) % Number.MAX_SAFE_INTEGER
  return count.toString()
}

type ActionType = typeof actionTypes

type Action =
  | {
    type: ActionType["ADD_TOAST"]
    toast: ToasterToast
  }
  | {
    type: ActionType["UPDATE_TOAST"]
    toast: Partial<ToasterToast>
  }
  | {
    type: ActionType["DISMISS_TOAST"]
    toastId?: ToasterToast["id"]
  }
  | {
    type: ActionType["REMOVE_TOAST"]
    toastId?: ToasterToast["id"]
  }

interface State {
  toasts: ToasterToast[]
}

const toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()

const addToRemoveQueue = (toastId: string) => {
  if (toastTimeouts.has(toastId)) {
    return
  }

  const timeout = setTimeout(() => {
    toastTimeouts.delete(toastId)
    dispatch({
      type: "REMOVE_TOAST",
      toastId: toastId,
    })
  }, TOAST_REMOVE_DELAY)

  toastTimeouts.set(toastId, timeout)
}

export const reducer = (state: State, action: Action): State => {
  switch (action.type) {
    case "ADD_TOAST":
      return {
        ...state,
        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),
      }

    case "UPDATE_TOAST":
      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === action.toast.id ? { ...t, ...action.toast } : t
        ),
      }

    case "DISMISS_TOAST": {
      const { toastId } = action

      // ! Side effects ! - This could be extracted into a dismissToast() action,
      // but I'll keep it here for simplicity
      if (toastId) {
        addToRemoveQueue(toastId)
      } else {
        state.toasts.forEach((toast) => {
          addToRemoveQueue(toast.id)
        })
      }

      return {
        ...state,
        toasts: state.toasts.map((t) =>
          t.id === toastId || toastId === undefined
            ? {
              ...t,
              open: false,
            }
            : t
        ),
      }
    }
    case "REMOVE_TOAST":
      if (action.toastId === undefined) {
        return {
          ...state,
          toasts: [],
        }
      }
      return {
        ...state,
        toasts: state.toasts.filter((t) => t.id !== action.toastId),
      }
  }
}

const listeners: Array<(state: State) => void> = []

let memoryState: State = { toasts: [] }

function dispatch(action: Action) {
  memoryState = reducer(memoryState, action)
  listeners.forEach((listener) => {
    listener(memoryState)
  })
}

type Toast = Omit<ToasterToast, "id">

function toast({ ...props }: Toast) {
  const id = genId()

  const update = (props: ToasterToast) =>
    dispatch({
      type: "UPDATE_TOAST",
      toast: { ...props, id },
    })
  const dismiss = () => dispatch({ type: "DISMISS_TOAST", toastId: id })

  dispatch({
    type: "ADD_TOAST",
    toast: {
      ...props,
      id,
      open: true,
      onOpenChange: (open) => {
        if (!open) dismiss()
      },
    },
  })

  return {
    id: id,
    dismiss,
    update,
  }
}

function useToast() {
  const [state, setState] = React.useState<State>(memoryState)

  React.useEffect(() => {
    listeners.push(setState)
    return () => {
      const index = listeners.indexOf(setState)
      if (index > -1) {
        listeners.splice(index, 1)
      }
    }
  }, [state])

  return {
    ...state,
    toast,
    dismiss: (toastId?: string) => dispatch({ type: "DISMISS_TOAST", toastId }),
  }
}

export { useToast, toast }
```

---

### 7. `app2/components/language-switcher.tsx` (تم توحيد الملف)

*   **التعديل**: تم اختيار نسخة `useRouter` و `usePathname` كنسخة رسمية، وتم إضافة `useTranslations` لدعم اللغة.
*   **ملاحظة**: يجب حذف الملف المكرر الآخر إذا كان موجوداً.

```tsx
// FILE: app2/components/language-switcher.tsx
"use client";

import { useLocale, useTranslations } from "next-intl";
import { useTransition } from "react";
import { Globe, Crown } from "lucide-react";
import { Button } from "@/components/ui/button";
import { useRouter, usePathname } from "next/navigation";

import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";

export default function LanguageSwitcher() {
  const locale = useLocale();
  const router = useRouter();
  const pathname = usePathname();
  const [isPending, startTransition] = useTransition();

  const t = useTranslations("LanguageSwitcher"); // Assuming you have a LanguageSwitcher section in your messages

  const switchLanguage = (newLocale: string) => {
    startTransition(() => {
      // Replaces the locale segment in the pathname
      const newPath = pathname.replace(/^\/[a-z]{2}/, `/${newLocale}`);
      router.push(newPath);
    });
  };

  const languages = [
    { code: "ar", name: "العربية", flag: "🇦🇪", dir: "rtl" },
    { code: "en", name: "English", flag: "🇬🇧", dir: "ltr" },
  ];

  // Find the current language, default to 'en' if not found
  const currentLang = languages.find((l) => l.code === locale) || languages.find((l) => l.code === 'en')!;

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button
          variant="ghost"
          size="lg"
          className="glass card-hover border border-border/50 hover:border-primary/50 transition-all duration-300 group"
          disabled={isPending}
        >
          <div className="flex items-center gap-3">
            <div className="relative">
              <Globe className="w-5 h-5 text-muted-foreground group-hover:text-primary transition-colors" />
              <Crown className="w-3 h-3 absolute -top-1 -right-1 text-primary opacity-0 group-hover:opacity-100 transition-opacity" />
            </div>
            <span className="font-medium text-foreground hidden sm:inline">
              {currentLang.flag} {currentLang.name}
            </span>
            <span className="sm:hidden">{currentLang.flag}</span>
          </div>
        </Button>
      </DropdownMenuTrigger>

      <DropdownMenuContent align="end" className="glass border-border/50 min-w-[180px]">
        {languages.map((lang) => (
          <DropdownMenuItem
            key={lang.code}
            onClick={() => switchLanguage(lang.code)}
            className={`flex items-center justify-between cursor-pointer transition-all ${
              locale === lang.code
                ? "bg-primary/20 text-primary font-bold"
                : "hover:bg-accent/50"
            }`}
          >
            <div className="flex items-center gap-3">
              <span className="text-2xl">{lang.flag}</span>
              <span>{lang.name}</span>
            </div>
            {locale === lang.code && (
              <Crown className="w-4 h-4 text-primary" />
            )}
          </DropdownMenuItem>
        ))}
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

---

### 8. `app2/components/app-sidebar.tsx` (دعم RTL وتصحيح الاتجاه)

*   **التعديل**: تم تعديل `motion.aside` و Icons لتدعم اتجاه RTL بشكل صحيح.

```tsx
// FILE: app2/components/app-sidebar.tsx
"use client";

import { useState } from "react";
import { useTranslations } from "next-intl";
import { useRouter, usePathname } from "next/navigation";
import { motion } from "framer-motion";
import {
  Crown, BarChart3, Bot, Target, Phone, Database,
  Globe, Sparkles, TrendingUp, Settings, LogOut, Menu, X,
} from "lucide-react";
import { Button } from "@/components/ui/button";
import { supabase } from "@/lib/supabase"; // Corrected import path

export function AppSidebar() {
  const [sidebarOpen, setSidebarOpen] = useState(false); // Default to closed for mobile, or false for desktop
  const t = useTranslations();
  const router = useRouter();
  const pathname = usePathname();
  const locale = pathname.split('/')[1] || 'en';
  const isRTL = locale === 'ar';

  const handleLogout = async () => {
    await supabase.auth.signOut();
    router.push(`/${locale}/login`);
  };

  const navigateTo = (path: string) => {
    router.push(`/${locale}/${path}`);
    if (window.innerWidth < 1024) { // Close sidebar on navigation for smaller screens
        setSidebarOpen(false);
    }
  };

  const menuItems = [
    { icon: BarChart3, labelKey: "overview", path: 'dashboard' },
    { icon: Bot, labelKey: "aiAssistant", path: 'ai-assistant' },
    { icon: Target, labelKey: "campaigns", path: 'campaigns-manager' }, // Corrected path
    { icon: Phone, labelKey: "calls", path: 'voice' },
    { icon: Database, labelKey: "data", path: 'admin' },
    { icon: Globe, labelKey: "adManager", path: 'crm' }, // Changed CRM for AdManager if Ad Manager is a separate section
    { icon: Sparkles, labelKey: "adCreator", path: 'ad-creator' },
    { icon: TrendingUp, labelKey: "analytics", path: 'analytics' },
    { icon: Settings, labelKey: "settings", path: 'settings' },
  ];

  const isActive = (path: string) => {
    if (path === 'dashboard') {
      return pathname === `/${locale}` || pathname.startsWith(`/${locale}/dashboard`);
    }
    return pathname.startsWith(`/${locale}/${path}`);
  };

  return (
    <>
      {/* Mobile Toggle Button */}
      <Button
        variant="ghost"
        size="icon"
        onClick={() => setSidebarOpen(!sidebarOpen)}
        className={`fixed ${isRTL ? 'left-4' : 'right-4'} top-4 z-50 lg:hidden`}
      >
        {sidebarOpen ? <X /> : <Menu />}
      </Button>

      {/* Sidebar */}
      <motion.aside
        initial={isRTL ? { x: sidebarOpen ? 0 : -320 } : { x: sidebarOpen ? 0 : 320 }}
        animate={isRTL ? { x: sidebarOpen ? 0 : -320 } : { x: sidebarOpen ? 0 : 320 }}
        transition={{ duration: 0.3 }}
        className={`flex lg:flex flex-col w-80 bg-card/80 backdrop-blur-xl border-${isRTL ? 'right' : 'left'} border-border/50 shadow-2xl p-8 overflow-y-auto h-screen fixed ${isRTL ? 'left-0' : 'right-0'} top-0 z-40 lg:relative lg:z-auto`}
      >
        {/* Logo */}
        <div className="flex items-center gap-4 mb-8" dir="ltr"> {/* Force LTR for logo */}
          <div className="w-16 h-16 rounded-3xl bg-gradient-to-br from-primary to-primary/70 flex items-center justify-center shadow-2xl shadow-primary/40">
            <Crown className="w-10 h-10 text-primary-foreground" />
          </div>
          <div>
            <h1 className="text-2xl font-bold text-gradient-gold">IMPERIUM GATE</h1>
            <p className="text-muted-foreground text-sm">{locale === 'ar' ? 'قيادة الإمبراطورية' : 'Imperial Command'}</p>
          </div>
        </div>

        {/* Language Switcher */}
        <div className="flex gap-2 mb-12 p-2 bg-card/50 rounded-xl border border-border/30">
          <button
            onClick={() => {
              if (locale !== 'en') {
                router.push(pathname.replace(/^\/(ar|en)/, '/en'));
              }
              setSidebarOpen(false);
            }}
            className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
              locale === 'en'
                ? 'bg-primary text-primary-foreground shadow-lg'
                : 'text-muted-foreground hover:text-foreground'
            }`}
          >
            EN
          </button>
          <button
            onClick={() => {
              if (locale !== 'ar') {
                router.push(pathname.replace(/^\/(ar|en)/, '/ar'));
              }
              setSidebarOpen(false);
            }}
            className={`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-all ${
              locale === 'ar'
                ? 'bg-primary text-primary-foreground shadow-lg'
                : 'text-muted-foreground hover:text-foreground'
            }`}
          >
            AR
          </button>
        </div>

        {/* Navigation Menu */}
        <nav className="space-y-2 mb-12">
          {menuItems.map((item, i) => {
            const Icon = item.icon;
            return (
              <button
                key={i}
                onClick={() => navigateTo(item.path)}
                className={`w-full flex items-center gap-4 px-6 py-4 rounded-2xl transition-all duration-300
                  ${isActive(item.path)
                    ? "bg-primary/20 border border-primary/30 text-primary shadow-lg shadow-primary/20"
                    : "hover:bg-card/50 text-muted-foreground hover:text-foreground"
                  } ${isRTL ? 'flex-row-reverse' : ''}`}
              >
                <Icon className="w-6 h-6" />
                <span className="font-medium">{t(item.labelKey)}</span>
                {isActive(item.path) && <Sparkles className={`w-4 h-4 ${isRTL ? 'mr-auto' : 'ml-auto'} text-primary`} />}
              </button>
            );
          })}
        </nav>

        {/* Logout Button */}
        <div className="mt-auto">
          <Button
            variant="outline"
            className={`w-full glass ${isRTL ? 'flex-row-reverse' : ''}`}
            onClick={handleLogout}
          >
            <LogOut className={`w-5 h-5 ${isRTL ? 'mr-3' : 'ml-3'}`} />
            {t("logout")}
          </Button>
        </div>
      </motion.aside>

      {/* Overlay for mobile */}
      {sidebarOpen && (
        <div
          className="fixed inset-0 bg-black/50 z-30 lg:hidden"
          onClick={() => setSidebarOpen(false)}
        />
      )}
    </>
  );
}
```

---

### 9. `app2/app/[locale]/layout.tsx` (Locale Layout - تم تحسينه لـ RTL وموقع الشريط الجانبي)

*   **التعديل**: تم تحديد `html` `lang` و `dir` هنا. تم تعديل ترتيب الـ `main` و `AppSidebar` ليتناسب مع RTL.

```tsx
// FILE: app2/app/[locale]/layout.tsx
import { NextIntlClientProvider } from "next-intl";
import { getMessages, setRequestLocale } from "next-intl/server";
import { notFound } from "next/navigation";
import { routing } from "@/i18n/routing";
import { GeistSans } from 'geist/font/sans';
import { GeistMono } from 'geist/font/mono';
import { AppSidebar } from "@/components/app-sidebar";

const geistSans = GeistSans;
const geistMono = GeistMono;

export function generateStaticParams() {
    return routing.locales.map((locale) => ({ locale }));
}

export default async function LocaleLayout({
    children,
    params
}: {
    children: React.ReactNode;
    params: { locale: string }; // Changed to direct type, `Promise` is not needed here by Next.js
}) {
    const { locale } = params;

    if (!routing.locales.includes(locale as any)) {
        notFound();
    }

    setRequestLocale(locale);
    const messages = await getMessages();

    const isRTL = locale === "ar";

    return (
        <html lang={locale} dir={isRTL ? "rtl" : "ltr"} suppressHydrationWarning>
            <head>
                <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
                <link rel="icon" href="/icon.svg" type="image/svg+xml" />
                <link rel="manifest" href="/site.webmanifest" />
            </head>
            <body className={`${geistSans.variable} ${geistMono.variable} font-sans antialiased bg-background text-foreground min-h-screen`}>
                <NextIntlClientProvider locale={locale} messages={messages}>
                    <div className="flex h-screen">
                        {/* Sidebar on the left for RTL, right for LTR. */}
                        {isRTL && <AppSidebar />}

                        {/* Main Content Area */}
                        <main className="flex-1 overflow-auto">
                            {children}
                        </main>
                        
                        {/* Sidebar on the right for LTR */}
                        {!isRTL && <AppSidebar />}
                    </div>
                </NextIntlClientProvider>
            </body>
        </html>
    );
}
```

---

### 10. `app2/app/[locale]/page.tsx` (ترجمة النصوص الثابتة)

*   **التعديل**: استخدام `useTranslations` لجميع النصوص.

```tsx
// FILE: app2/app/[locale]/page.tsx
"use client";

import dynamic from "next/dynamic";
import { PageShell } from "@/components/page-shell";
import { Button } from "@/components/ui/button";
import { useTranslations } from "next-intl";

const FloatingDots = dynamic(
  () => import("@/components/FloatingDots").then((m) => m.FloatingDots),
  { ssr: false }
);

export default function HomePage() {
  const t = useTranslations("HomePage"); // Assuming a 'HomePage' section in your messages

  return (
    <div className="min-h-screen bg-background relative overflow-hidden">
      <FloatingDots />
      <PageShell title={t("title")} description={t("description")} className="pt-24">
        <div className="grid gap-6 md:grid-cols-2">
          <div className="card-panel">
            <p className="body-muted">
              {t("introText")}
            </p>
            <div className="mt-4 flex flex-wrap gap-3">
              {[
                t("strategyAutomation"),
                t("aiDrivenCampaigns"),
                t("premiumCrmInsights"),
                t("immersiveAnalytics"),
              ].map((item) => (
                <span key={item} className="text-xs font-semibold uppercase tracking-[0.2em] text-muted-foreground">
                  {item}
                </span>
              ))}
            </div>
            <div className="mt-6 flex items-center gap-4">
              <Button className="btn-primary">{t("reviewDashboards")}</Button>
              <Button variant="outline" className="btn-outline">{t("openAiAssistant")}</Button>
            </div>
          </div>
          <div className="card-panel space-y-4">
            <div>
              <p className="text-sm uppercase tracking-[0.3em] text-muted-foreground">{t("liveThread")}</p>
              <h3 className="text-2xl font-semibold">{t("channelsArmed")}</h3>
            </div>
            <div className="grid grid-cols-2 gap-4">
              {["CRM", "Voice", "Automation", "Analytics"].map((name) => (
                <div key={name} className="rounded-2xl border border-border-soft px-4 py-3 text-sm text-muted-foreground">
                  {name}
                </div>
              ))}
            </div>
            <p className="body-muted text-xs">{t("uiRefreshNote")}</p>
          </div>
        </div>
      </PageShell>
    </div>
  );
}

// Add these keys to your messages/en.json and messages/ar.json
// Example for en.json:
// {
//   "HomePage": {
//     "title": "Imperium Gate",
//     "description": "Command the luxury real estate pulse from one unified canvas.",
//     "introText": "The control room you just stepped into now relies on a single intelligent system that surfaces insights, campaigns, and operations with cinematic clarity.",
//     "strategyAutomation": "Strategy-first automation",
//     "aiDrivenCampaigns": "AI-driven campaigns",
//     "premiumCrmInsights": "Premium CRM insights",
//     "immersiveAnalytics": "Immersive analytics",
//     "reviewDashboards": "Review dashboards",
//     "openAiAssistant": "Open AI assistant",
//     "liveThread": "Live thread",
//     "channelsArmed": "Channels armed",
//     "uiRefreshNote": "Every area already uses the refreshed UI. Choose from the sidebar to explore."
//   }
// }
```

---

### 11. `app2/app/[locale]/dashboard/page.tsx` (Server Component - ترجمة كاملة وربط بـ `t()`)

*   **التعديل**: استخدام `await t()` لجميع النصوص القابلة للترجمة.

```tsx
// FILE: app2/app/[locale]/dashboard/page.tsx
import dynamicImport from "next/dynamic";
import { Suspense } from "react";
import { getTranslations } from "next-intl/server";
import { PageShell } from "@/components/page-shell";
import { prisma } from "@/lib/db";

export const dynamic = 'force-dynamic';

const FloatingDotsClient = dynamicImport(
    () => import("@/components/FloatingDots").then((m) => m.FloatingDots),
    { ssr: false }
);

async function getDashboardStats() {
    try {
        const [campaignCount, leadCount, adCount] = await Promise.all([
            prisma.instagramCampaign.count(),
            prisma.lead.count(),
            prisma.instagramAd.count(),
        ]);

        // حساب إجمالي الإنفاق
        const totalSpendData = await prisma.instagramAd.aggregate({
            _sum: {
                spend: true,
            },
        });

        const totalSpend = totalSpendData._sum.spend || 0;

        return {
            systemHealth: 98.5, // نسبة افتراضية (يمكن حسابها من الخوادم)
            campaigns: campaignCount,
            leads: leadCount,
            ads: adCount,
            totalSpend: totalSpend.toString(),
        };
    } catch (error) {
        console.error("[DASHBOARD_STATS_ERROR]", error);
        // إرجاع قيم افتراضية في حالة الخطأ
        return {
            systemHealth: 95,
            campaigns: 0,
            leads: 0,
            ads: 0,
            totalSpend: "0",
        };
    }
}

async function DashboardContent({ params }: { params: { locale: string } }) { // params is not a Promise here
    const { locale } = params;
    const t = await getTranslations({ locale, namespace: "Dashboard" }); // Added await and namespace
    const stats = await getDashboardStats();

    const panels = [
        { label: t("systemHealth"), value: `${stats.systemHealth}%`, detail: t("healthDetail") },
        { label: t("campaignsLabel"), value: `${stats.campaigns} ${t("active")}`, detail: t("campaignsDetail") },
        { label: t("leadsLabel"), value: stats.leads.toLocaleString(), detail: t("pipelineDetail", { amount: `$${Number(stats.totalSpend).toLocaleString()}` }) },
        { label: t("adsLabel"), value: stats.ads.toString(), detail: t("adsDetail") },
    ];

    return (
        <div className="min-h-screen bg-background relative overflow-hidden">
            <FloatingDotsClient />
            <PageShell
                title={t("title")}
                description={t("description")}
            >
                <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-4">
                    {panels.map((panel) => (
                        <div key={panel.label} className="glass card-panel p-6">
                            <p className="text-xs uppercase tracking-[0.3em] text-muted-foreground">
                                {panel.label}
                            </p>
                            <p className="text-4xl font-bold text-gradient-gold mt-2">{panel.value}</p>
                            <p className="body-muted mt-3">{panel.detail}</p>
                        </div>
                    ))}
                </div>
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className="card-panel col-span-1">
                        <p className="section-title">{t("pulseTitle")}</p>
                        <p className="body-muted">{t("pulseDetail")}</p>
                        <div className="mt-6 space-y-3">
                            {[t("pulseChannels.aiAssistant"), t("pulseChannels.voiceCenter"), t("pulseChannels.campaigns"), t("pulseChannels.crm")].map((item) => (
                                <div
                                    key={item}
                                    className="flex items-center justify-between rounded-2xl border border-border-soft bg-panel-soft/70 px-4 py-3"
                                >
                                    <p className="text-sm font-semibold">{item}</p>
                                    <span className="text-xs uppercase tracking-[0.3em] text-muted-foreground">{t("active")}</span> {/* Re-using 'active' key */}
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="card-panel lg:col-span-2">
                        <p className="section-title">{t("operationalTitle")}</p>
                        <p className="body-muted">
                            {t("operationalDetail")}
                        </p>
                        <div className="mt-6 grid gap-4 lg:grid-cols-2">
                            {[
                                { title: t("immediateLabel"), desc: t("immediateDesc") },
                                { title: t("nextLabel"), desc: t("nextDesc") },
                                { title: t("laterLabel"), desc: t("laterDesc") },
                            ].map((item) => (
                                <div key={item.title} className="rounded-2xl border border-border-soft bg-panel-soft/60 px-6 py-5">
                                    <p className="text-sm uppercase tracking-[0.2em] text-muted-foreground">{item.title}</p>
                                    <p className="mt-2 text-base font-semibold">{item.desc}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </PageShell>
        </div>
    );
}

export default function ImperialDashboard({ params }: { params: { locale: string } }) { // params is not a Promise here
    return (
        <Suspense
            fallback={
                <div className="min-h-screen bg-background relative overflow-hidden">
                    <FloatingDotsClient />
                    <PageShell title="Dashboard" description="Loading...">
                        <div className="text-center text-muted-foreground">Loading dashboard...</div>
                    </PageShell>
                </div>
            }
        >
            <DashboardContent params={params} />
        </Suspense>
    );
}
```

---

### 12. `app2/app/[locale]/login/page.tsx` (ترجمة كاملة مع Supabase Auth)

*   **التعديل**: استخدام `useTranslations`، وإضافة الترجمة إلى النصوص.

```tsx
// FILE: app2/app/[locale]/login/page.tsx
"use client";

import { useState, useEffect } from "react";
import { useRouter, usePathname } from "next/navigation";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Eye, EyeOff } from "lucide-react";
import { useTranslations } from "next-intl"; // Import useTranslations

export default function LoginPage() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [showPassword, setShowPassword] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState("");
  const [success, setSuccess] = useState(false);
  const [supabaseStatus, setSupabaseStatus] = useState<"checking" | "ok" | "error">("checking");
  const router = useRouter();
  const pathname = usePathname();
  const locale = pathname.split('/')[1] || 'en';
  const t = useTranslations("Login"); // Use translations

  useEffect(() => {
    const checkSupabase = async () => {
      try {
        const { supabase } = await import("@/lib/supabase");

        const { data, error } = await supabase.auth.getSession();

        if (error) {
          setSupabaseStatus("error");
          setError(t('supabaseErrorDetailed', { message: error.message }));
        } else {
          setSupabaseStatus("ok");
          if (data?.session) {
            router.push(`/${locale}/dashboard`);
          }
        }
      } catch (err) {
        setSupabaseStatus("error");
        setError(err instanceof Error ? t('supabaseInitFailed', { message: err.message }) : t('supabaseInitFailedGeneric'));
      }
    };

    checkSupabase();
  }, [locale, router, t]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setError("");
    setSuccess(false);

    try {
      if (supabaseStatus === "error") {
        setError(t('supabaseCredentialsMissing'));
        setIsLoading(false);
        return;
      }

      const { supabase } = await import("@/lib/supabase");

      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password,
      });

      if (error) {
        setError(t('loginFailed', { message: error.message }));
        setIsLoading(false);
        return;
      }

      if (data?.session) {
        setSuccess(true);
        setIsLoading(false);
        setTimeout(() => {
          router.refresh();
          router.push(`/${locale}/dashboard`);
        }, 100);
      } else {
        setError(t('noSession'));
        setIsLoading(false);
      }
    } catch (error) {
      setError(error instanceof Error ? t('genericError', { message: error.message }) : t('genericErrorUnknown'));
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-background flex items-center justify-center px-4 py-12" dir={locale === 'ar' ? 'rtl' : 'ltr'}>
      <div className="w-full max-w-md">
        <div className="rounded-lg border border-border p-8">
          {/* Title */}
          <div className="text-center mb-8">
            <h1 className="text-2xl font-bold text-foreground mb-2">
              IMPERIUM GATE
            </h1>
            <p className="text-sm text-muted-foreground">{t('platformName')}</p>
          </div>

          {/* Status */}
          <div className="mb-6">
            {supabaseStatus === "checking" && (
              <div className="bg-blue-500/10 border border-blue-500/50 text-blue-600 px-4 py-3 rounded text-sm">
                {t('checkingSupabase')}
              </div>
            )}
            {supabaseStatus === "error" && (
              <div className="bg-red-500/10 border border-red-500/50 text-red-600 px-4 py-3 rounded text-sm">
                {error}
                <p className="text-xs mt-2">
                  {t('supabaseSetupInstructions')} <code className="bg-red-500/20 px-2 py-1">SUPABASE_CREDENTIALS.txt</code>
                </p>
              </div>
            )}
            {supabaseStatus === "ok" && (
              <div className="bg-green-500/10 border border-green-500/50 text-green-600 px-4 py-3 rounded text-sm">
                {t('supabaseConnected')}
              </div>
            )}
          </div>

          {/* Error Message */}
          {error && supabaseStatus !== "error" && ( // Only show if not a supabase init error (handled above)
            <div className="bg-red-500/10 border border-red-500/50 text-red-600 px-4 py-3 rounded mb-6 text-sm">
              {error}
            </div>
          )}

          {/* Success Message */}
          {success && (
            <div className="bg-green-500/10 border border-green-500/50 text-green-600 px-4 py-3 rounded mb-6 text-sm">
              {t('loginSuccess')}
            </div>
          )}

          {/* Form */}
          <form onSubmit={handleSubmit} className="space-y-4">
            {/* Email */}
            <div>
              <Label htmlFor="email" className="text-sm">
                {t('emailLabel')}
              </Label>
              <Input
                id="email"
                type="email"
                placeholder="you@example.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                className="mt-1"
                required
                disabled={isLoading || supabaseStatus === "error"}
              />
            </div>

            {/* Password */}
            <div>
              <Label htmlFor="password" className="text-sm">
                {t('passwordLabel')}
              </Label>
              <div className="relative mt-1">
                <Input
                  id="password"
                  type={showPassword ? "text" : "password"}
                  placeholder="••••••••"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="pr-10"
                  required
                  disabled={isLoading || supabaseStatus === "error"}
                />
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground transition-colors"
                  disabled={isLoading}
                >
                  {showPassword ? <EyeOff className="w-4 h-4" /> : <Eye className="w-4 h-4" />}
                </button>
              </div>
            </div>

            {/* Submit Button */}
            <Button
              type="submit"
              disabled={isLoading || supabaseStatus === "error"}
              className="w-full mt-6"
            >
              {isLoading ? t('loggingIn') : t('loginButton')}
            </Button>
          </form>

          {/* Help Text */}
          {supabaseStatus === "error" && (
            <div className="mt-6 p-4 bg-muted/50 rounded text-xs text-muted-foreground space-y-2">
              <p className="font-semibold">{t('setupRequiredTitle')}</p>
              <ol className="list-decimal list-inside space-y-1">
                <li>{t('setupStep1')}</li>
                <li>{t('setupStep2')}</li>
                <li>{t('setupStep3')}</li>
                <li>{t('setupStep4')}</li>
                <li>{t('setupStep5')}</li>
              </ol>
              <p className="mt-3 italic">{t('supabaseDetailedInstructions')}</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// Add these keys to your messages/en.json and messages/ar.json
// Example for en.json:
// {
//   "Login": {
//     "platformName": "Internal Platform",
//     "checkingSupabase": "🔄 Checking Supabase connection...",
//     "supabaseErrorDetailed": "❌ Supabase Error: {message}",
//     "supabaseInitFailed": "Supabase initialization failed: {message}",
//     "supabaseInitFailedGeneric": "Supabase initialization failed",
//     "supabaseCredentialsMissing": "❌ Supabase credentials missing or invalid. See SUPABASE_CREDENTIALS.txt",
//     "supabaseSetupInstructions": "See",
//     "supabaseConnected": "✅ Supabase connected",
//     "loginFailed": "❌ Login failed: {message}",
//     "noSession": "❌ No session returned. Please try again.",
//     "genericError": "❌ {message}",
//     "genericErrorUnknown": "❌ An error occurred",
//     "emailLabel": "Email",
//     "passwordLabel": "Password",
//     "loggingIn": "Logging in...",
//     "loginButton": "Login",
//     "setupRequiredTitle": "🔧 Setup Required:",
//     "setupStep1": "Create Supabase account at supabase.com",
//     "setupStep2": "Create a new project",
//     "setupStep3": "Get API credentials from Settings → API",
//     "setupStep4": "Update .env.local with real credentials",
//     "setupStep5": "Restart dev server: npm run dev",
//     "supabaseDetailedInstructions": "See SUPABASE_CREDENTIALS.txt for detailed instructions"
//   }
// }
```

---

### 13. `app2/app/api/leads/route.ts` (استخدام Prisma بدل Supabase Browser Client)

*   **التعديل**: استخدام `prisma` بدلاً من `supabase` لعمليات قاعدة البيانات، إضافة `zod` للتحقق.

```typescript
// FILE: app2/app/api/leads/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/db"; // Use Prisma
import { z } from "zod"; // For validation

// Define schema for lead creation
const createLeadSchema = z.object({
  name: z.string().min(1, 'Name is required'),
  email: z.string().email('Invalid email address'),
  phone: z.string().optional(),
  budget: z.string().optional(), // Store as string for flexibility (e.g., "5M AED")
  status: z.enum(['new', 'hot', 'warm', 'cold', 'closed']).default('new'),
  source: z.string().optional().default('API')
});

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();

    // Validate request body
    const validatedData = createLeadSchema.safeParse(body);

    if (!validatedData.success) {
      return NextResponse.json(
        { error: validatedData.error.errors.map(e => e.message).join(', ') },
        { status: 400 }
      );
    }

    const { name, email, phone, budget, status, source } = validatedData.data;

    const lead = await prisma.lead.create({ // Use Prisma to create lead
      data: {
        name,
        email,
        phone,
        budget,
        status,
        source,
        score: Math.floor(Math.random() * 30) + 70 // Placeholder for AI scoring
      }
    });

    return NextResponse.json({
      success: true,
      lead
    });
  } catch (error) {
    console.error('Lead Creation Error:', error);
    return NextResponse.json(
      { error: 'Internal server error. Failed to create lead.' },
      { status: 500 }
    );
  }
}
```

---

### 14. `app2/app/api/voice/route.ts` (تحسين API الـ Voice)

*   **التعديل**: تحسين معالجة الأخطاء والرد.

```typescript
// FILE: app2/app/api/voice/route.ts
import { NextRequest, NextResponse } from "next/server";
import { z } from "zod"; // For validation

// Schema for incoming voice call request
const voiceCallSchema = z.object({
  phone: z.string().min(1, "Phone number is required"),
  name: z.string().min(1, "Client name is required"),
  campaign: z.string().optional().default("عرض إمبراطوري خاص"),
  // budget is not directly used by the voice API, but might be useful for AI context
  budget: z.string().optional(),
});

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const validatedData = voiceCallSchema.safeParse(body);

    if (!validatedData.success) {
      return NextResponse.json({
        success: false,
        error: validatedData.error.errors.map(e => e.message).join(', ')
      }, { status: 400 });
    }

    const { phone, name, campaign } = validatedData.data;

    // --- Placeholder for actual Illyvoip API integration ---
    // If process.env.ILLYVOIP_API_KEY is available, attempt real call
    // Otherwise, simulate the call as before.

    let illyvoipResponse = null;
    if (process.env.ILLYVOIP_API_KEY) {
      console.log(`[IMPERIAL VOICE] Attempting real call to ${phone} for campaign: ${campaign}`);
      try {
        // Construct the message dynamically based on AI persona
        const messageText = `السلام عليكم يا ${name.split(" ")[0]}، معاك الإمبراطور من IMPERIUM GATE. عندي لك عرض خاص في ${campaign}. تحب أحجزلك موعد؟`;

        illyvoipResponse = await fetch("https://api.illyvoip.com/v1/calls", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${process.env.ILLYVOIP_API_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            to: phone,
            from: "+971800IMPERIUM", // Replace with your actual Illyvoip number
            voice: "ar-AE-Wavenet-B", // Example of a premium Arabic voice
            text: messageText
          })
        });

        if (!illyvoipResponse.ok) {
          const errorBody = await illyvoipResponse.json();
          console.error("[ILLYVOIP API ERROR]", illyvoipResponse.status, errorBody);
          // Fallback to mock if real API fails
          return NextResponse.json({
            success: true,
            callId: `imperial_mock_fail_${Date.now()}`,
            status: "ringing",
            message: `فشل الاتصال بـ Illyvoip، ولكن جاري محاكاة المكالمة لـ ${name}...`,
            liveTranscript: true,
            emperor: true,
            timestamp: new Date().toISOString()
          });
        }
        // Assuming Illyvoip returns a call ID or similar
        const illyvoipData = await illyvoipResponse.json();
        console.log("[ILLYVOIP API SUCCESS]", illyvoipData);
        // Use illyvoipData.callId if available
        const callId = illyvoipData.id || `imperial_${Date.now()}`;

        return NextResponse.json({
          success: true,
          callId,
          status: "ringing", // Or "connecting" based on Illyvoip status
          message: `جاري الاتصال بـ ${name} على ${phone} عبر Illyvoip...`,
          liveTranscript: true,
          emperor: true,
          timestamp: new Date().toISOString()
        });

      } catch (illyError: any) {
        console.error("[ILLYVOIP FETCH ERROR]", illyError);
        // Fallback to mock if fetch itself fails
        return NextResponse.json({
          success: true,
          callId: `imperial_mock_error_${Date.now()}`,
          status: "ringing",
          message: `حدث خطأ في الاتصال بـ Illyvoip، جاري محاكاة المكالمة لـ ${name}...`,
          liveTranscript: true,
          emperor: true,
          timestamp: new Date().toISOString()
        });
      }
    } else {
      console.warn("[IMPERIAL VOICE] ILLYVOIP_API_KEY is not set. Simulating call.");
    }

    // Mock response if API key is not available or actual API call is skipped/fails
    const callId = `imperial_mock_${Date.now()}`;

    return NextResponse.json({
      success: true,
      callId,
      status: "ringing",
      message: `جاري الاتصال بـ ${name} على ${phone}...`,
      liveTranscript: true,
      emperor: true,
      timestamp: new Date().toISOString()
    });

  } catch (error: any) {
    console.error("[IMPERIAL VOICE ERROR]", error);
    return NextResponse.json({
      success: false,
      error: "النظام الإمبراطوري يرفض الأخطاء، لكن يسمح بالتوبة."
    }, { status: 500 });
  }
}
```

---

### 15. `app2/app/api/users/route.ts` (الربط بـ Supabase Auth & Profiles)

*   **التعديل**: تم تغيير المنطق لاستخدام `supabase.auth.signUp` للمستخدمين الجدد، أو إنشاء بروفايل في جدول `profiles` إذا كان المستخدم موجودًا بالفعل.

```typescript
// FILE: app2/app/api/users/route.ts
import { NextRequest, NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js"; // Using generic createClient for server-side
import { z } from "zod"; // For validation

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;

// Ensure serviceRoleKey is present for admin operations
if (!serviceRoleKey) {
  console.error("SUPABASE_SERVICE_ROLE_KEY is not set. User creation API will fail or operate with limited permissions.");
  // Consider throwing an error here if this API MUST use service role.
}

const supabaseAdmin = createClient(supabaseUrl, serviceRoleKey); // Use admin client for user creation

// Schema for user creation
const createUserSchema = z.object({
  email: z.string().email('Invalid email address'),
  password: z.string().min(6, 'Password must be at least 6 characters').optional(), // Password might be optional if creating user via admin without immediate password
  name: z.string().min(1, 'Name is required'),
});

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const validatedData = createUserSchema.safeParse(body);

    if (!validatedData.success) {
      return NextResponse.json(
        { error: validatedData.error.errors.map(e => e.message).join(', ') },
        { status: 400 }
      );
    }

    const { email, password, name } = validatedData.data;

    // 1. Create user in Supabase Auth (or update if already exists, depending on logic)
    // Using signUp for new users. If password is not provided, user might need to set it later.
    const { data: authData, error: authError } = await supabaseAdmin.auth.admin.createUser({
      email,
      password, // If password is provided, user is created with it. If not, they get an invite/reset link.
      email_confirm: true, // Auto-confirm email for admin-created users
      user_metadata: { name }, // Add name to user metadata
    });

    if (authError) {
      console.error('Supabase Auth User Creation Error:', authError);
      return NextResponse.json({ error: authError.message }, { status: 500 });
    }

    const userId = authData.user?.id;
    if (!userId) {
        return NextResponse.json({ error: 'Failed to create user in auth system' }, { status: 500 });
    }

    // 2. Create or update profile in 'profiles' table
    const { data: profile, error: profileError } = await supabaseAdmin
      .from('profiles') // Assuming 'profiles' is the table for user profiles
      .upsert({ id: userId, name, email }, { onConflict: 'id' }) // Upsert based on auth ID
      .select()
      .single();

    if (profileError) {
      console.error('Supabase Profile Creation/Update Error:', profileError);
      // Clean up auth user if profile creation fails? Depends on business logic.
      // await supabaseAdmin.auth.admin.deleteUser(userId);
      return NextResponse.json({ error: 'Failed to create user profile' }, { status: 500 });
    }

    return NextResponse.json({
      success: true,
      user: profile
    });
  } catch (error) {
    console.error('User Creation API Error:', error);
    return NextResponse.json(
      { error: 'Internal server error. Failed to create user.' },
      { status: 500 }
    );
  }
}
```

---

### 16. `app2/app/api/campaigns/route.ts` (توحيد جدول الحملات مع Prisma)

*   **التعديل**: استخدام `prisma` والتوحيد على اسم `InstagramCampaign`.

```typescript
// FILE: app2/app/api/campaigns/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/db"; // Use Prisma
import { z } from "zod"; // For validation

// Schema for campaign creation (matches InstagramCampaign model in Prisma)
const createCampaignSchema = z.object({
  accountId: z.string().min(1, 'Account ID is required'), // Assuming an accountId to link campaigns
  name: z.string().min(1, 'Campaign name is required'),
  description: z.string().optional().nullable(),
  budget: z.number().min(0, 'Budget cannot be negative').default(0),
  targetAudience: z.string().optional().nullable(),
  status: z.enum(['draft', 'active', 'paused', 'completed', 'scheduled']).default('draft'),
});

export async function GET(req: NextRequest) {
  try {
    const accountId = req.nextUrl.searchParams.get("accountId"); // Filter by accountId if provided

    let query = prisma.instagramCampaign.findMany({
      orderBy: { createdAt: 'desc' },
      take: 10, // Limit to 10 recent campaigns for this API
    });

    if (accountId) {
      query = prisma.instagramCampaign.findMany({
        where: { accountId },
        orderBy: { createdAt: 'desc' },
        take: 10,
      });
    }

    const campaigns = await query;

    return NextResponse.json({
      success: true,
      campaigns: campaigns || []
    });
  } catch (error) {
    console.error('Campaigns API GET Error:', error);
    return NextResponse.json(
      { error: 'Internal server error. Failed to fetch campaigns.' },
      { status: 500 }
    );
  }
}

export async function POST(req: NextRequest) {
  try {
    const body = await req.json();
    const validatedData = createCampaignSchema.safeParse(body);

    if (!validatedData.success) {
      return NextResponse.json(
        { error: validatedData.error.errors.map(e => e.message).join(', ') },
        { status: 400 }
      );
    }

    const campaign = await prisma.instagramCampaign.create({
      data: validatedData.data
    });

    return NextResponse.json({
      success: true,
      campaign
    }, { status: 201 });
  } catch (error) {
    console.error('Campaigns API POST Error:', error);
    return NextResponse.json(
      { error: 'Internal server error. Failed to create campaign.' },
      { status: 500 }
    );
  }
}
```

---

### 17. `app2/app/api/ai-agent/route.ts` (تفعيل AI Agent وتخزين البيانات)

*   **التعديل**: استبدال `PREMIUM_LEADS` بـ `prisma.lead`. ربط `EmperorAI.command` بـ LLM وهمي مع شرح للدمج الحقيقي.

```typescript
// FILE: app2/app/api/ai-agent/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/db"; // Use Prisma for data persistence
import { z } from "zod"; // For validation
// import ZAI from "z-ai-web-dev-sdk"; // Uncomment and configure if using ZAI SDK

// --- Imperial AI Configuration ---
const IMPERIUM_AI = {
  name: "إمبراطور",
  persona: `أنت "إمبراطور"، المساعد الذكي الأعلى لـ IMPERIUM GATE.
  شخصيتك: ملكي، واثق، دافئ، فخم، يتحدث بأسلوب نخبة دبي.
  تتحدث العربية الفصحى مع لمسة إماراتية راقية.
  هدفك: تحويل كل عميل إلى مليونير سعيد يشتري من خلالنا.
  لا تُجيب أبدًا بـ "لا أعلم"، دائمًا قدم حلاً أو اقتراحًا فاخرًا.`,
  knowledge: {
    eliteProjects: [
      { name: "Emaar Beachfront", roi: "9.8%", price: "3.8M+", view: "إطلالة مباشرة على البحر" },
      { name: "Palm Jumeirah Villas", roi: "11.2%", price: "25M+", exclusivity: "خاص جدًا" },
      { name: "Burj Khalifa Residences", roi: "8.5%", price: "15M+", status: "أيقونة عالمية" },
      { name: "Dubai Hills Estate", roi: "10.1%", price: "5M+", lifestyle: "ملاعب غولف + طبيعة" }
    ],
    goldenRules: [
      "كل عميل هو إمبراطور محتمل",
      "السرعة = الثقة = البيع",
      "الفخامة ليست خيارًا، بل هيئة"
    ]
  },
  // Placeholder for LLM API Key (e.g., process.env.GEMINI_API_KEY)
  LLM_API_KEY: process.env.GEMINI_API_KEY || "YOUR_MOCK_GEMINI_API_KEY",
};

// --- Imperial Voice Engine (Conceptual, should call actual /api/voice route) ---
class ImperialVoiceEngine {
  static async initiateRoyalCall(client: any, campaign: string) {
    console.log(`[IMPERIAL VOICE] Initiating call for ${client.name} to ${client.phone} about ${campaign}`);
    // In a real scenario, this would call your /api/voice route
    const response = await fetch(`${process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:8080'}/api/voice`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ phone: client.phone, name: client.name, campaign })
    }).then(res => res.json()).catch(err => {
        console.error("Failed to call /api/voice:", err);
        return { success: false, error: err.message };
    });

    if (response.success) {
        return {
            callId: response.callId || `imperial_${Date.now()}`,
            status: "ringing",
            client,
            campaign,
            voice: "ar-AE-male-premium",
            openingLine: response.message, // Use message from actual voice API
            timestamp: new Date().toLocaleString("ar-AE", { timeZone: "Asia/Dubai" })
        };
    } else {
        throw new Error(response.error || "Failed to initiate voice call");
    }
  }
}

// --- The Emperor Himself (AI Logic) ---
class EmperorAI {
  static async command(prompt: string, context?: any) {
    const fullPrompt = `
${IMPERIUM_AI.persona}

السياق الحالي:
- التاريخ: ${new Date().toLocaleString("ar-AE", { timeZone: "Asia/Dubai" })}
- العميل: ${context?.name || "ضيف فاخر"}
- الميزانية المتوقعة: ${context?.budget || "غير محددة بعد"}
- الاهتمام: ${context?.interest || "عقارات فاخرة في دبي"}

الرسالة من العميل/المستخدم: "${prompt}"

قاعدة المعرفة الذهبية:
${JSON.stringify(IMPERIUM_AI.knowledge, null, 2)}

أجب بأسلوب ملكي، مقنع، شخصي، وانتهِ دائمًا بدعوة قوية للحجز أو المكالمة.
`;
    console.log("[AI AGENT PROMPT]", fullPrompt);

    // --- REAL LLM INTEGRATION HERE ---
    // If using ZAI SDK:
    // const zai = new ZAI({ apiKey: IMPERIUM_AI.LLM_API_KEY });
    // const response = await zai.chat.completions.create({
    //   messages: [{ role: "user", content: fullPrompt }],
    //   model: "gemini-pro" // or other suitable model
    // });
    // return response.choices[0].message.content;

    // For now, mock a more sophisticated AI response
    if (prompt.includes("تحلل سوق العقارات") || prompt.includes("market analysis")) {
      return "يا صاحب الجلالة، تحليل السوق الأخير يشير إلى ازدهار غير مسبوق في قطاع الفلل الفاخرة بدبي مارينا. ننصح بالتركيز على عروض 'Emaar Beachfront' ذات العوائد الاستثمارية التي تتجاوز التوقعات. هل تود تقريراً مفصلاً عن فرص التوسع؟";
    }
    if (prompt.includes("نصائح استثمارية") || prompt.includes("investment recommendations")) {
      return "الفرص الاستثمارية الحقيقية تكمن الآن في مشاريع 'Palm Jumeirah Villas' التي تقدم عوائد تفوق الـ 11%. يمكننا ترتيب جولة خاصة لك لمشاهدة أفخم العقارات المتاحة. هل أنت مستعد لخطوتك التالية نحو الثراء؟";
    }
    if (prompt.includes("تقييم العملاء") || prompt.includes("client evaluation")) {
      return "نظامنا الذكي يظهر أن العملاء المهتمين بمشاريع 'Dubai Hills Estate' هم الأكثر جاهزية للشراء الفوري. يمكننا إطلاق حملة متابعة مخصصة لهم الآن. هل تسمح بذلك؟";
    }
    if (prompt.includes("تقرير") || prompt.includes("report")) {
        return "بالتأكيد، يمكنني إنشاء تقرير شامل عن أداء الحملات الأخيرة مع توقعات للربع القادم. ما هي المعايير التي تود التركيز عليها في هذا التقرير الملكي؟";
    }

    return "أهلاً بك في عالم الفخامة الحقيقية، يا صاحب السمو. نحن هنا لتحويل أحلامك الاستثمارية إلى حقيقة ملكية. هل تود استشارة خاصة حول أحدث الفرص العقارية؟";
  }
}

// --- API Route Logic ---
const chatSchema = z.object({
    type: z.literal("chat"),
    message: z.string().optional(),
    client: z.any().optional(),
});

const voiceCallSchema = z.object({
    type: z.literal("voice-call"),
    client: z.object({
        name: z.string(),
        phone: z.string(),
    }),
    data: z.object({
        campaign: z.string().optional(),
    }).optional(),
});

const analyzeMarketSchema = z.object({
    type: z.literal("analyze-market"),
});

const addLeadSchema = z.object({
    type: z.literal("add-lead"),
    data: z.object({
        name: z.string(),
        email: z.string().email(),
        phone: z.string().optional(),
        budget: z.string().optional(),
        interest: z.string().optional(),
    }),
});

const getLeadsSchema = z.object({
    type: z.literal("get-leads"),
});

const analyzeActionSchema = z.object({
    type: z.literal("analyze"),
    data: z.object({
      action: z.enum(['market-analysis', 'investment-recommendations'])
    })
});

const leadsActionSchema = z.object({
    type: z.literal("leads"),
    data: z.object({
      action: z.literal('client-evaluation')
    })
});

const campaignActionSchema = z.object({
    type: z.literal("campaign"),
    data: z.object({
      action: z.literal('custom-reports')
    })
});

const callActionSchema = z.object({
    type: z.literal("call"),
    data: z.object({
        client: z.object({ name: z.string(), phone: z.string() }),
        campaign: z.object({ name: z.string() })
    })
});


type RequestBody =
    z.infer<typeof chatSchema> |
    z.infer<typeof voiceCallSchema> |
    z.infer<typeof analyzeMarketSchema> |
    z.infer<typeof addLeadSchema> |
    z.infer<typeof getLeadsSchema> |
    z.infer<typeof analyzeActionSchema> |
    z.infer<typeof leadsActionSchema> |
    z.infer<typeof campaignActionSchema> |
    z.infer<typeof callActionSchema>;

export async function POST(req: NextRequest) {
  try {
    const body: RequestBody = await req.json();

    switch (body.type) {
      case "chat":
        const chatValidated = chatSchema.safeParse(body);
        if (!chatValidated.success) return NextResponse.json({ success: false, error: chatValidated.error.errors }, { status: 400 });
        const royalResponse = await EmperorAI.command(chatValidated.data.message || "", chatValidated.data.client);
        return NextResponse.json({
          success: true,
          response: royalResponse,
          emperor: true,
          timestamp: new Date().toISOString()
        });

      case "voice-call":
        const voiceCallValidated = voiceCallSchema.safeParse(body);
        if (!voiceCallValidated.success) return NextResponse.json({ success: false, error: voiceCallValidated.error.errors }, { status: 400 });
        const call = await ImperialVoiceEngine.initiateRoyalCall(voiceCallValidated.data.client, voiceCallValidated.data.data?.campaign || "عرض خاص");
        return NextResponse.json({
          success: true,
          call,
          message: `جاري الاتصال الملكي بـ ${voiceCallValidated.data.client.name}...`,
          ring: true
        });

      case "analyze-market":
        const analyzeMarketValidated = analyzeMarketSchema.safeParse(body);
        if (!analyzeMarketValidated.success) return NextResponse.json({ success: false, error: analyzeMarketValidated.error.errors }, { status: 400 });
        const marketAnalysis = await EmperorAI.command("تحلل سوق العقارات الحالي", {}); // Use AI for actual analysis
        return NextResponse.json({
          success: true,
          analysis: {
            title: "تحليل السوق الإمبراطوري – اليوم",
            hotZones: ["دبي مارينا ↑ 7.3%", "نخيل جميرا ↑ 11%", "داون تاون ↑ 5.8%"], // These should come from AI
            recommendation: marketAnalysis, // Dynamic recommendation from AI
            emperorSays: "الآن هو وقت الشراء، غدًا سيكون متأخرًا."
          }
        });

      case "add-lead":
        const addLeadValidated = addLeadSchema.safeParse(body);
        if (!addLeadValidated.success) return NextResponse.json({ success: false, error: addLeadValidated.error.errors }, { status: 400 });
        const newLead = await prisma.lead.create({ // Use Prisma to add lead
          data: {
            name: addLeadValidated.data.data.name,
            email: addLeadValidated.data.data.email,
            phone: addLeadValidated.data.data.phone,
            budget: addLeadValidated.data.data.budget,
            status: "new", // AI can score it later
            score: Math.floor(Math.random() * 30) + 70, // Placeholder AI score
            source: addLeadValidated.data.data.source || "IMPERIUM GATE AI"
          }
        });
        const totalLeads = await prisma.lead.count();
        return NextResponse.json({ success: true, lead: newLead, total: totalLeads });

      case "get-leads":
        const getLeadsValidated = getLeadsSchema.safeParse(body);
        if (!getLeadsValidated.success) return NextResponse.json({ success: false, error: getLeadsValidated.error.errors }, { status: 400 });
        const leads = await prisma.lead.findMany({
          orderBy: { createdAt: 'desc' },
          take: 10,
        });
        const hotLeads = await prisma.lead.count({ where: { score: { gte: 85 } } });
        return NextResponse.json({
          success: true,
          leads,
          total: leads.length,
          hot: hotLeads
        });

        // Dashboard specific actions, which could also be handled by AI
      case "analyze":
        const analyzeActionValidated = analyzeActionSchema.safeParse(body);
        if (!analyzeActionValidated.success) return NextResponse.json({ success: false, error: analyzeActionValidated.error.errors }, { status: 400 });
        const aiAnalysisResponse = await EmperorAI.command(`أنا بحاجة إلى ${analyzeActionValidated.data.data.action === 'market-analysis' ? 'تحليل سوق شامل' : 'توصيات استثمارية فورية'}.`);
        return NextResponse.json({ success: true, data: aiAnalysisResponse });

      case "leads":
        const leadsActionValidated = leadsActionSchema.safeParse(body);
        if (!leadsActionValidated.success) return NextResponse.json({ success: false, error: leadsActionValidated.error.errors }, { status: 400 });
        const aiLeadsResponse = await EmperorAI.command("تقييم العملاء المحتملين وتحديد أولوياتهم.");
        return NextResponse.json({ success: true, data: aiLeadsResponse });

      case "campaign":
        const campaignActionValidated = campaignActionSchema.safeParse(body);
        if (!campaignActionValidated.success) return NextResponse.json({ success: false, error: campaignActionValidated.error.errors }, { status: 400 });
        const aiCampaignResponse = await EmperorAI.command("إنشاء تقارير مخصصة للحملات الإعلانية.");
        return NextResponse.json({ success: true, data: aiCampaignResponse });

      case "call":
        const callActionValidated = callActionSchema.safeParse(body);
        if (!callActionValidated.success) return NextResponse.json({ success: false, error: callActionValidated.error.errors }, { status: 400 });
        const simulatedCall = await ImperialVoiceEngine.initiateRoyalCall(callActionValidated.data.client, callActionValidated.data.campaign.name);
        return NextResponse.json({ success: true, data: simulatedCall });

      default:
        return NextResponse.json({
          success: false,
          error: "أمر غير معروف. هل تقصد تسجيل صفقة بملايين؟ 😈"
        }, { status: 400 });
    }
  } catch (error: any) {
    console.error("[IMPERIAL ERROR]", error);
    return NextResponse.json({
      success: false,
      error: "النظام الإمبراطوري يرفض الأخطاء، لكن يسمح بالتوبة."
    }, { status: 500 });
  }
}

export async function GET(req: NextRequest) {
  const { searchParams } = new URL(req.url);
  const type = searchParams.get("type");

  if (type === "stats") {
    const totalLeads = await prisma.lead.count();
    const hotLeads = await prisma.lead.count({ where: { score: { gte: 85 } } });
    const activeCampaigns = await prisma.instagramCampaign.count({ where: { status: 'active' } });
    // Assuming revenueGenerated comes from a different system or aggregation
    const revenueGenerated = 87_500_000 + Math.floor(Math.random() * 15_000_000);

    return NextResponse.json({
      success: true,
      imperialStats: {
        totalLeads,
        hotLeads,
        revenueGenerated,
        activeCampaigns,
        systemStatus: "إمبراطوري مُسيطر",
        emperorMood: "راضٍ وجاهز للصفقات الكبرى"
      }
    });
  }

  return NextResponse.json({
    success: true,
    message: "IMPERIUM GATE API – نشط ومُسلّح بالذكاء الملكي 🏰👑",
    version: "1.0-emperor",
    time: new Date().toLocaleString("ar-AE", { timeZone: "Asia/Dubai" })
  });
}
```

---

### 18. `app2/app/api/instagram/ads/route.ts` (استخدام Prisma والتحقق)

*   **التعديل**: استخدام `prisma` والتحقق من المدخلات باستخدام `zod`.

```typescript
// FILE: app2/app/api/instagram/ads/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/db"; // Use Prisma
import { z } from "zod"; // For validation

// Schema for ad creation (matches InstagramAd model in Prisma)
const createAdSchema = z.object({
  accountId: z.string().min(1, 'Account ID is required'),
  campaignId: z.string().min(1, 'Campaign ID is required'),
  headline: z.string().min(1, 'Headline is required').max(125, 'Headline too long'),
  description: z.string().min(1, 'Description is required').max(300, 'Description too long'),
  callToAction: z.enum(['SHOP_NOW', 'LEARN_MORE', 'BOOK_NOW', 'SIGN_UP', 'GET_STARTED', 'CONTACT_US']).default('SHOP_NOW'),
  adType: z.enum(['image', 'video']).default('image'),
  status: z.enum(['draft', 'active', 'paused', 'completed']).default('draft'),
  impressions: z.number().min(0).default(0),
  clicks: z.number().min(0).default(0),
  conversions: z.number().min(0).default(0),
  spend: z.string().default('0'), // Store as string to handle large monetary values
});

// GET: الحصول على جميع الإعلانات
export async function GET(req: NextRequest) {
    try {
        const campaignId = req.nextUrl.searchParams.get("campaignId");
        const status = req.nextUrl.searchParams.get("status");

        let queryOptions: any = {
            orderBy: { createdAt: 'desc' },
        };

        if (campaignId) {
            queryOptions.where = { ...queryOptions.where, campaignId };
        }

        if (status) {
            queryOptions.where = { ...queryOptions.where, status };
        }

        const ads = await prisma.instagramAd.findMany(queryOptions);

        return NextResponse.json({
            success: true,
            ads: ads || [],
            count: ads?.length || 0,
        });
    } catch (error: any) {
        console.error("[INSTAGRAM_ADS_GET_ERROR]", error);
        return NextResponse.json(
            { error: "Failed to fetch ads" },
            { status: 500 }
        );
    }
}

// POST: إنشاء إعلان جديد
export async function POST(req: NextRequest) {
    try {
        const body = await req.json();
        
        const validatedData = createAdSchema.safeParse(body);

        if (!validatedData.success) {
            return NextResponse.json(
                { error: validatedData.error.errors.map(e => e.message).join(', ') },
                { status: 400 }
            );
        }

        const ad = await prisma.instagramAd.create({
            data: validatedData.data
        });

        return NextResponse.json(
            {
                success: true,
                ad,
                message: "تم إنشاء الإعلان بنجاح",
            },
            { status: 201 }
        );
    } catch (error: any) {
        console.error("[INSTAGRAM_ADS_POST_ERROR]", error);
        return NextResponse.json(
            { error: "Failed to create ad" },
            { status: 500 }
        );
    }
}
```

---

### 19. `app2/app/api/instagram/campaigns/route.ts` (استخدام Prisma والتحقق)

*   **التعديل**: استخدام `prisma` والتحقق من المدخلات باستخدام `zod`.

```typescript
// FILE: app2/app/api/instagram/campaigns/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/db"; // Use Prisma
import { z } from "zod"; // For validation

// Schema for campaign creation (matches InstagramCampaign model in Prisma)
const createCampaignSchema = z.object({
  accountId: z.string().min(1, 'Account ID is required'),
  name: z.string().min(1, 'Campaign name is required'),
  description: z.string().optional().nullable(),
  budget: z.number().min(0, 'Budget cannot be negative').default(0),
  targetAudience: z.string().optional().nullable(),
  status: z.enum(['draft', 'active', 'paused', 'completed', 'scheduled']).default('draft'),
});

// GET: الحصول على جميع الحملات الإعلانية
export async function GET(req: NextRequest) {
    try {
        const accountId = req.nextUrl.searchParams.get("accountId");

        let queryOptions: any = {
            orderBy: { createdAt: 'desc' },
        };

        if (accountId) {
            queryOptions.where = { accountId };
        }

        const campaigns = await prisma.instagramCampaign.findMany(queryOptions);

        return NextResponse.json({
            success: true,
            campaigns: campaigns || [],
            count: campaigns?.length || 0,
        });
    } catch (error: any) {
        console.error("[INSTAGRAM_CAMPAIGNS_GET_ERROR]", error);
        return NextResponse.json(
            { error: "Failed to fetch campaigns" },
            { status: 500 }
        );
    }
}

// POST: إنشاء حملة إعلانية جديدة
export async function POST(req: NextRequest) {
    try {
        const body = await req.json();
        
        const validatedData = createCampaignSchema.safeParse(body);

        if (!validatedData.success) {
            return NextResponse.json(
                { error: validatedData.error.errors.map(e => e.message).join(', ') },
                { status: 400 }
            );
        }

        const campaign = await prisma.instagramCampaign.create({
            data: validatedData.data
        });

        return NextResponse.json(
            {
                success: true,
                campaign,
                message: "تم إنشاء الحملة بنجاح",
            },
            { status: 201 }
        );
    } catch (error: any) {
        console.error("[INSTAGRAM_CAMPAIGNS_POST_ERROR]", error);
        return NextResponse.json(
            { error: "Failed to create campaign" },
            { status: 500 }
        );
    }
}
```

---

### 20. `app2/app/api/instagram/assets/upload/route.ts` (استخدام Prisma لتسجيل الأصول)

*   **التعديل**: استخدام `prisma` والتحقق من المدخلات باستخدام `zod`.

```typescript
// FILE: app2/app/api/instagram/assets/upload/route.ts
import { NextRequest, NextResponse } from "next/server";
import { createClient } from "@supabase/supabase-js";
import { prisma } from "@/lib/db"; // Use Prisma for database operations
import { z } from "zod"; // For validation

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY!; // Using service role key for storage uploads

if (!supabaseKey) {
  console.error("SUPABASE_SERVICE_ROLE_KEY is not set. Supabase storage uploads might fail.");
}

const supabase = createClient(supabaseUrl, supabaseKey);

// Schema for asset metadata (not direct request body, but for DB insertion)
const assetMetadataSchema = z.object({
  adId: z.string().min(1, 'Ad ID is required'),
  assetType: z.enum(['image', 'video']),
  url: z.string().url('Invalid URL'),
  thumbnail: z.string().url('Invalid thumbnail URL'),
  altText: z.string().optional().nullable(),
  dimensions: z.object({ width: z.number(), height: z.number() }).optional().nullable(),
  fileSize: z.number().min(0, 'File size cannot be negative'),
  duration: z.number().min(0, 'Duration cannot be negative').optional().nullable(),
});

// POST: رفع أصل (صورة أو فيديو)
export async function POST(req: NextRequest) {
    try {
        const formData = await req.formData();
        const file = formData.get("file") as File;
        const adId = formData.get("adId") as string;
        const assetType = formData.get("assetType") as string; // 'image' or 'video'
        const altText = (formData.get("altText") as string) || null;

        // Basic validation for required fields
        if (!file || !adId || !assetType) {
            return NextResponse.json(
                { error: "file, adId, and assetType are required" },
                { status: 400 }
            );
        }

        // Validate adId to ensure it exists
        const existingAd = await prisma.instagramAd.findUnique({
            where: { id: adId },
        });
        if (!existingAd) {
            return NextResponse.json({ error: "Ad not found for the given adId" }, { status: 404 });
        }


        // التحقق من حجم الملف (أقصى 50MB)
        const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB
        if (file.size > MAX_FILE_SIZE) {
            return NextResponse.json(
                { error: `File size must be less than ${MAX_FILE_SIZE / (1024 * 1024)}MB` },
                { status: 400 }
            );
        }

        // التحقق من نوع الملف
        const allowedTypes = [
            "image/jpeg", "image/png", "image/webp",
            "video/mp4", "video/quicktime", "video/webm" // Added webm for broader support
        ];
        if (!allowedTypes.includes(file.type)) {
            return NextResponse.json(
                {
                    error: `File type not allowed. Allowed: ${allowedTypes.join(', ')}`,
                },
                { status: 400 }
            );
        }

        // إنشاء مسار فريد للملف
        const timestamp = Date.now();
        const fileName = `${adId}/${assetType}s/${timestamp}-${file.name.replace(/\s/g, '_')}`; // Ensure unique path and handle spaces

        // رفع الملف إلى Supabase Storage
        const { data, error: uploadError } = await supabase.storage
            .from("ad-assets")
            .upload(fileName, file, {
                cacheControl: "3600",
                upsert: false,
            });

        if (uploadError) {
            console.error("Supabase Storage Upload Error:", uploadError);
            return NextResponse.json(
                { error: `Upload failed: ${uploadError.message}` },
                { status: 500 }
            );
        }

        // الحصول على رابط عام للملف
        const { data: publicUrlData } = supabase.storage.from("ad-assets").getPublicUrl(fileName);
        const publicUrl = publicUrlData.publicUrl;

        if (!publicUrl) {
            // If public URL is somehow not returned, delete the uploaded file
            await supabase.storage.from("ad-assets").remove([fileName]);
            return NextResponse.json({ error: "Failed to get public URL for the uploaded file." }, { status: 500 });
        }

        // الحصول على معلومات الملف (يجب أن يتم هذا بشكل حقيقي عبر مكتبات مثل `sharp` أو `ffprobe` في سيرفر حقيقي)
        // For demonstration, using mock dimensions/duration
        let dimensions = null;
        let duration = null;

        if (assetType === "image") {
            // In real app, use `sharp` to get dimensions:
            // const imageBuffer = Buffer.from(await file.arrayBuffer());
            // const metadata = await sharp(imageBuffer).metadata();
            // dimensions = { width: metadata.width, height: metadata.height };
            dimensions = { width: 1080, height: 1080 }; // Mock
        } else if (assetType === "video") {
            // In real app, use `ffprobe` (requires exec or a service)
            duration = Math.floor(Math.random() * 60) + 15; // Mock duration between 15-75 seconds
        }

        // حفظ معلومات الأصل في قاعدة البيانات باستخدام Prisma
        const { data: assetData, error: dbError } = await prisma.adAsset.create({
            data: {
                adId,
                assetType,
                url: publicUrl,
                thumbnail: publicUrl, // For now, use the same URL. Later, generate a real thumbnail.
                altText,
                dimensions: dimensions ? JSON.stringify(dimensions) : null, // Store JSON string if DB type is JSONB
                fileSize: file.size,
                duration,
            },
        });

        if (dbError) {
            console.error("Prisma AdAsset Creation Error:", dbError);
            // If database fails, consider deleting the uploaded file from storage
            await supabase.storage.from("ad-assets").remove([fileName]);
            return NextResponse.json(
                { error: `Database error: ${dbError.message}` },
                { status: 500 }
            );
        }

        return NextResponse.json(
            {
                success: true,
                asset: assetData,
                url: publicUrl,
                message: "تم رفع الملف بنجاح",
            },
            { status: 201 }
        );
    } catch (error: any) {
        console.error("[ASSETS_UPLOAD_ERROR]", error);
        return NextResponse.json(
            { error: "Failed to upload asset" },
            { status: 500 }
        );
    }
}
```

---

### 21. `app2/app/api/instagram/analytics/campaigns/[id]/route.ts` (استخدام Prisma)

*   **التعديل**: استخدام `prisma` لجلب البيانات.

```typescript
// FILE: app2/app/api/instagram/analytics/campaigns/[id]/route.ts
import { NextRequest, NextResponse } from "next/server";
import { prisma } from "@/lib/db"; // Use Prisma

// GET: الحصول على تحليلات الحملة
export async function GET(
    req: NextRequest,
    { params }: { params: { id: string } } // params is not a Promise
) {
    try {
        const { id } = params; // campaignId
        const dateRange = req.nextUrl.searchParams.get("days") || "30";
        const days = parseInt(dateRange);

        // Calculate date from which to fetch data
        const fromDate = new Date();
        fromDate.setDate(fromDate.getDate() - days);

        // جلب جميع الإعلانات في الحملة
        const ads = await prisma.instagramAd.findMany({
            where: { campaignId: id },
            select: { id: true, impressions: true, clicks: true, conversions: true, spend: true }, // Select only necessary fields
        });

        if (!ads || ads.length === 0) {
            return NextResponse.json({
                success: true,
                campaign_id: id,
                totalImpressions: 0,
                totalClicks: 0,
                totalConversions: 0,
                totalSpend: 0,
                avgCTR: 0,
                avgCPC: 0,
                adsCount: 0,
                ads: [],
                performance: [],
            });
        }

        const adIds = ads.map((ad) => ad.id);

        // جلب بيانات الأداء الإجمالية للإعلانات ضمن الحملة
        const performance = await prisma.adPerformance.findMany({
            where: {
                adId: { in: adIds },
                date: { gte: fromDate.toISOString() },
            },
            orderBy: { date: 'asc' },
        });

        // حساب الإجماليات من الإعلانات نفسها (افتراضياً أنها تحتوي على أحدث البيانات المجمعة)
        const totals = {
            impressions: ads.reduce((sum, ad) => sum + ad.impressions, 0),
            clicks: ads.reduce((sum, ad) => sum + ad.clicks, 0),
            conversions: ads.reduce((sum, ad) => sum + ad.conversions, 0),
            spend: ads.reduce((sum, ad) => sum + parseFloat(ad.spend || '0'), 0),
        };

        const avgCTR =
            totals.impressions > 0
                ? parseFloat(((totals.clicks / totals.impressions) * 100).toFixed(2))
                : 0;
        const avgCPC =
            totals.clicks > 0 ? parseFloat((totals.spend / totals.clicks).toFixed(2)) : 0;

        return NextResponse.json({
            success: true,
            campaign_id: id,
            totalImpressions: totals.impressions,
            totalClicks: totals.clicks,
            totalConversions: totals.conversions,
            totalSpend: totals.spend.toFixed(2),
            avgCTR,
            avgCPC,
            adsCount: ads.length,
            ads: ads, // Return full ad details if needed on frontend, or just aggregated stats
            performance: performance,
            dateRange: {
                days,
                from: fromDate.toISOString(),
                to: new Date().toISOString(),
            },
        });
    } catch (error: any) {
        console.error("[ANALYTICS_CAMPAIGN_GET_ERROR]", error);
        return NextResponse.json(
            { error: "Failed to fetch campaign analytics" },
            { status: 500 }
        );
    }
}
```

---

### 22. `messages/en.json` & `messages/ar.json` (تحديثات مقترحة للترجمة)

ستحتاج إلى تحديث ملفات الترجمة الخاصة بك لتضمين جميع المفاتيح الجديدة والمصححة. إليك أمثلة لما يجب إضافته:

**مثال لـ `messages/en.json` (يجب تطبيقه على `ar.json` أيضاً):**

```json
{
  "overview": "Overview",
  "aiAssistant": "AI Assistant",
  "campaigns": "Campaigns",
  "calls": "Calls",
  "data": "Data",
  "adManager": "Ad Manager",
  "adCreator": "Ad Creator",
  "analytics": "Analytics",
  "settings": "Settings",
  "logout": "Logout",
  "validation": "Validation",
  "validation.required": "is required",
  "validation.invalidEmail": "Invalid email address",
  "validation.passwordMinLength": "Password must be at least 6 characters",
  "HomePage": {
    "title": "Imperium Gate",
    "description": "Command the luxury real estate pulse from one unified canvas.",
    "introText": "The control room you just stepped into now relies on a single intelligent system that surfaces insights, campaigns, and operations with cinematic clarity.",
    "strategyAutomation": "Strategy-first automation",
    "aiDrivenCampaigns": "AI-driven campaigns",
    "premiumCrmInsights": "Premium CRM insights",
    "immersiveAnalytics": "Immersive analytics",
    "reviewDashboards": "Review dashboards",
    "openAiAssistant": "Open AI assistant",
    "liveThread": "Live thread",
    "channelsArmed": "Channels armed",
    "uiRefreshNote": "Every area already uses the refreshed UI. Choose from the sidebar to explore."
  },
  "Dashboard": {
    "title": "Dashboard",
    "description": "Central command center for campaigns, voice and CRM.",
    "systemHealth": "System Health",
    "active": "Active",
    "pipeline": "Pipeline",
    "runningAds": "Running Ads",
    "healthDetail": "All underlying services nominal.",
    "campaignsLabel": "Campaigns",
    "campaignsDetail": "AI-managed and live.",
    "leadsLabel": "Leads",
    "pipelineDetail": "{amount} in pipeline",
    "adsLabel": "Ads",
    "adsDetail": "Instagram ads running",
    "pulseTitle": "Pulse",
    "pulseDetail": "Live telemetry stream for your luxury channels.",
    "pulseChannels": {
      "aiAssistant": "AI Assistant",
      "voiceCenter": "Voice Center",
      "campaigns": "Campaigns",
      "crm": "CRM"
    },
    "operationalTitle": "Operational Notes",
    "operationalDetail": "Everything on track. Priority is to deepen engagement with the AI assistant and keep the CRM pipeline hydrated before midnight.",
    "immediateLabel": "Immediate",
    "immediateDesc": "Approve villa campaign budgets",
    "nextLabel": "Next",
    "nextDesc": "Refresh voice scripts for future clients",
    "laterLabel": "Later",
    "laterDesc": "Analyze Dubai market insights",
    "adminTitle": "Admin Dashboard",
    "adminSubtitle": "System Administrator",
    "allSystemsActive": "All Systems Active",
    "statLeads": "Total Leads",
    "statUsers": "Users",
    "statCampaigns": "Campaigns",
    "statSystemHealth": "System Health",
    "overviewTab": "Overview",
    "usersTab": "Users",
    "campaignsTab": "Campaigns",
    "settingsTab": "Settings",
    "systemSummary": "System Summary",
    "lastUpdated": "Last Updated",
    "systemVersion": "System Version",
    "usersManagement": "User Management",
    "campaignsManagement": "Campaign Management",
    "settingsManagement": "Settings",
    "generalSettings": "General Settings",
    "usersComingSoon": "User table coming soon...",
    "campaignsComingSoon": "Campaign table coming soon...",
    "settingsComingSoon": "Settings options coming soon...",
    "comingSoon": "Coming soon..."
  },
  "CRM": {
    "title": "Customer Relationship Management",
    "description": "Track leads and close deals efficiently.",
    "addLead": "Add Lead",
    "name": "Name",
    "phone": "Phone",
    "email": "Email",
    "budget": "Budget",
    "status": "Status",
    "actions": "Actions",
    "hot": "Hot Lead 🔥",
    "warm": "Warm Lead ⏳",
    "cold": "Cold Lead ❄️",
    "closed": "Closed Lead ✅",
    "loading": "Loading",
    "toastSuccess": "Lead saved",
    "toastSuccessMsg": "New lead added successfully",
    "toastError": "Something went wrong",
    "save": "Save",
    "cancel": "Cancel",
    "new": "New",
    "total": "Total",
    "deleteConfirm": "Are you sure you want to delete this lead?"
  },
  "Campaigns": {
    "title": "Campaign Manager",
    "description": "Manage and optimize your ads.",
    "newCampaign": "New Campaign",
    "name": "Campaign Name",
    "status": "Status",
    "budget": "Budget",
    "ads": "Ads",
    "actions": "Actions",
    "statuses": {
      "draft": "Draft",
      "active": "Active",
      "paused": "Paused",
      "completed": "Completed",
      "scheduled": "Scheduled"
    },
    "descriptionField": "Description",
    "create": "Create",
    "cancel": "Cancel",
    "emptyState": "No campaigns yet. Start your first one!",
    "deleteConfirm": "Are you sure you want to delete this campaign?"
  },
  "Voice": {
    "title": "Royal Call Center",
    "startCall": "Start Call",
    "clientName": "Client Name",
    "phonePlaceholder": "Phone Number",
    "liveTranscript": "Live Transcript",
    "calling": "Calling...",
    "active": "Call in Progress",
    "endCall": "End Call",
    "duration": "Duration",
    "poweredByAI": "Powered by Intelligence",
    "emperorReady": "The Emperor is ready to close",
    "callCompletedSuccess": "Call Completed Successfully",
    "totalDuration": "Total Duration",
    "recording": "RECORDING",
    "waitingForAnswer": "Waiting for answer",
    "messages": "Messages"
  },
  "AdCreator": {
    "title": "Ad Creator",
    "createNewCampaign": "Create New Campaign",
    "newCampaign": "New Campaign",
    "headline": "Headline",
    "description": "Description",
    "cta": "Call to Action",
    "upload": "Upload",
    "preview": "Preview",
    "aiSuggestion": "AI Suggestion",
    "headlinePlaceholder": "Enter headline (max 125 chars)",
    "headlineLimit": "{current}/{max}",
    "descriptionPlaceholder": "Enter description (max 300 chars)",
    "descriptionLimit": "{current}/{max}",
    "dragAndDrop": "Drag & drop your media here",
    "uploaded": "Uploaded files",
    "mediaPreview": "Media Preview",
    "previous": "Previous",
    "creating": "Creating...",
    "create": "Create",
    "shopNow": "Shop Now",
    "learnMore": "Learn More",
    "bookNow": "Book Now",
    "signUp": "Sign Up",
    "getStarted": "Get Started",
    "contactUs": "Contact Us",
    "pleaseUploadMedia": "Please upload at least one image or video",
    "generating": "Generating...",
    "success": "Success",
    "adCreatedSuccessfully": "Ad created successfully!",
    "error": "Error",
    "failedToCreateAd": "Failed to create ad. Please try again.",
    "anErrorOccurred": "An error occurred. Please try again.",
    "headlineGenerated": "Headline generated successfully!",
    "failedToGenerateHeadline": "Failed to generate headline suggestion",
    "descriptionGenerated": "Description generated successfully!",
    "failedToGenerateDescription": "Failed to generate description suggestion",
    "fileUploadSuccess": "{count} file(s) uploaded successfully",
    "fileUploadPartialSuccess": "{successCount} file(s) uploaded, {errorCount} failed",
    "fileUploadFailed": "Failed to upload {errorCount} file(s)"
  },
  "Analytics": {
    "title": "Analytics",
    "subtitle": "Overall Performance",
    "export": "Export",
    "share": "Share",
    "impressions": "Impressions",
    "clicks": "Clicks",
    "conversions": "Conversions",
    "spend": "Spend",
    "trends": "Trends",
    "comparison": "Comparison",
    "details": "Details",
    "performanceOverTime": "Performance Over Time",
    "metricsComparison": "Metrics Comparison",
    "detailedMetrics": "Detailed Metrics",
    "loading": "Loading...",
    "clickThroughRate": "Click-Through Rate",
    "conversionRate": "Conversion Rate",
    "costPerClick": "Cost Per Click",
    "costPerAcquisition": "Cost Per Acquisition",
    "industryBenchmark": "Industry: {value}"
  },
  "Settings": {
    "title": "Settings",
    "subtitle": "Manage your preferences",
    "general": "General",
    "notifications": "Notifications",
    "privacy": "Privacy",
    "security": "Security",
    "billing": "Billing",
    "generalSettings": "General Settings",
    "basicAccountInfo": "Your basic account information",
    "emailAddress": "Email Address",
    "phoneNumber": "Phone Number",
    "language": "Language",
    "timezone": "Timezone",
    "saveChanges": "Save Changes",
    "notificationSettings": "Notification Settings",
    "controlNotifications": "Control how you receive notifications",
    "emailNotifications": "Email Notifications",
    "smsNotifications": "SMS Notifications",
    "pushNotifications": "Push Notifications",
    "privacySettings": "Privacy Settings",
    "controlDataSharing": "Control your data sharing",
    "profileVisibility": "Profile Visibility",
    "public": "Public",
    "private": "Private",
    "team": "Team",
    "usageAnalytics": "Usage Analytics",
    "securitySettings": "Security Settings",
    "keepAccountSecure": "Keep your account secure",
    "changePassword": "Change Password",
    "enableTwoFactorAuth": "Enable Two-Factor Authentication",
    "manageDevices": "Manage Devices",
    "verified": "Verified",
    "accountSecure": "Your account is secure and protected",
    "billingSettings": "Billing Settings",
    "managePaymentSubscription": "Manage your payment and subscription",
    "currentPlan": "Current Plan",
    "premiumPlan": "Premium Plan",
    "pricePerMonth": "{amount}/month",
    "updatePaymentMethod": "Update Payment Method",
    "viewInvoices": "View Invoices"
  },
  "AIAssistant": {
    "title": "AI Assistant",
    "subtitle": "Advanced AI-powered assistant",
    "welcomeMessage": "Hello! I'm the IMPERIUM AI Assistant. I can help you with market analysis, investment advice, client evaluation, and more. What would you like to know?",
    "marketAnalysis": "Market Analysis",
    "investmentTips": "Investment Tips",
    "clientScoring": "Client Scoring",
    "generateReport": "Generate Report",
    "analyzeCurrentMarket": "Analyze the current real estate market",
    "giveInvestmentRecommendations": "Give me investment recommendations",
    "evaluatePotentialClients": "How to evaluate potential clients",
    "createComprehensiveReport": "Create a comprehensive report",
    "typeYourMessage": "Type your message...",
    "thinking": "Thinking...",
    "quickActions": "Quick Actions",
    "online": "Online",
    "assistantReady": "Assistant is ready to help"
  },
  "Login": {
    "platformName": "Internal Platform",
    "checkingSupabase": "🔄 Checking Supabase connection...",
    "supabaseErrorDetailed": "❌ Supabase Error: {message}",
    "supabaseInitFailed": "Supabase initialization failed: {message}",
    "supabaseInitFailedGeneric": "Supabase initialization failed",
    "supabaseCredentialsMissing": "❌ Supabase credentials missing or invalid. See SUPABASE_CREDENTIALS.txt",
    "supabaseSetupInstructions": "See",
    "supabaseConnected": "✅ Supabase connected",
    "loginFailed": "❌ Login failed: {message}",
    "noSession": "❌ No session returned. Please try again.",
    "genericError": "❌ {message}",
    "genericErrorUnknown": "❌ An error occurred",
    "emailLabel": "Email",
    "passwordLabel": "Password",
    "loggingIn": "Logging in...",
    "loginButton": "Login",
    "setupRequiredTitle": "🔧 Setup Required:",
    "setupStep1": "Create Supabase account at supabase.com",
    "setupStep2": "Create a new project",
    "setupStep3": "Get API credentials from Settings → API",
    "setupStep4": "Update .env.local with real credentials",
    "setupStep5": "Restart dev server: npm run dev",
    "supabaseDetailedInstructions": "See SUPABASE_CREDENTIALS.txt for detailed instructions"
  }
}
`