// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL") // Pooled connection (pgbouncer)
  directUrl = env("DIRECT_URL")   // Direct connection (migration)
}

// ===== USER MODEL (Updated with Role) =====

model User {
  id                   String             @id @default(uuid())
  email                String             @unique
  name                 String?
  password             String?            // ✅ Internal password storage
  role                 String             @default("user")
  isActive             Boolean            @default(true)      // ✅ For admin control (enable/disable users)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  // Relations
  aiAutoReplyRules     AIAutoReplyRule[]
  notifications        Notification[] // ✅ Added for Internal Notifications
}


// ===== CRM MODELS =====

model Lead {
  id     String  @id @default(cuid())
  name   String
  email  String?
  phone  String?
  budget String?
  status String  @default("new") // Kept for backward compatibility, but Stage should be used primarily
  score  Int     @default(0)
  source String  @default("MANUAL") // Updated: MANUAL as default

  // Source Details (Instagram/Ads)
  sourcePlatform String? // e.g. "instagram", "facebook"
  sourceUrl      String? // Ad Link / Destination URL
  sourceVideoUrl String? // Video URL if available
  sourceType     String? // "Video", "Image", "Carousel"

  // New CRM Fields
  pipelineId     String?
  stageId        String?
  priority       String   @default("MEDIUM") // LOW, MEDIUM, HIGH
  expectedValue  Decimal? @default(0)
  assignedTo     String? // Employee name/ID who is responsible for this lead
  campaignId     String?  @db.Text // NEW: Link to Campaign table
  conversationId String? // NEW: Link to Conversation for unified inbox

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  pipeline          Pipeline?          @relation(fields: [pipelineId], references: [id])
  stage             Stage?             @relation(fields: [stageId], references: [id])
  activities        Activity[]
  calls             Call[]
  campaign          Campaign?          @relation(fields: [campaignId], references: [id]) // NEW: Relation to Campaign
  instagramMessages InstagramMessage[]
  whatsappMessages  WhatsappMessage[]
  notifications     Notification[] // ✅ Added for Internal Notifications

  @@index([pipelineId])
  @@index([stageId])
  @@index([assignedTo])
  @@index([campaignId]) // NEW: Index for campaign filtering
  @@index([conversationId])
}

model Pipeline {
  id        String  @id @default(cuid())
  name      String
  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  stages Stage[]
  leads  Lead[]
}

model Stage {
  id         String @id @default(cuid())
  pipelineId String
  name       String
  order      Int    @default(0)
  color      String @default("#000000")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  pipeline Pipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  leads    Lead[]

  @@index([pipelineId])
}

model Activity {
  id           String    @id @default(cuid())
  leadId       String
  type         String // CALL, NOTE, EMAIL, MEETING, WHATSAPP, INSTAGRAM, REMINDER
  content      String    @db.Text
  performedBy  String? // Employee name/ID
  scheduledFor DateTime? // For follow-up reminders
  aiSummary    String?   @db.Text // AI-generated summary
  duration     Int? // Duration in minutes (for calls/meetings)
  isCompleted  Boolean   @default(true) // For scheduled activities

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([leadId])
  @@index([scheduledFor])
  @@index([isCompleted])
}

// ===== ZADARMA CALLS MODULE =====

model Call {
  id            String    @id @default(cuid())
  zadarmaCallId String?   @unique // ID from Zadarma API
  leadId        String?
  phoneNumber   String
  direction     String // INBOUND, OUTBOUND
  status        String // INITIATED, RINGING, ANSWERED, ENDED, FAILED
  duration      Int? // Duration in seconds
  recordingUrl  String? // URL to call recording
  transcript    String?   @db.Text // Speech recognition transcript
  startedAt     DateTime?
  endedAt       DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  lead Lead? @relation(fields: [leadId], references: [id])

  @@index([leadId])
  @@index([zadarmaCallId])
  @@index([phoneNumber])
  @@index([direction])
  @@index([status])
}

// ===== CAMPAIGNS & ADS MODULE =====

model Campaign {
  id         String    @id @default(cuid())
  name       String
  // Merged Fields
  status     String    @default("DRAFT") // ACTIVE, PAUSED, COMPLETED, ARCHIVED
  platform   String    @default("FACEBOOK") // FACEBOOK, INSTAGRAM, GOOGLE, TIKTOK
  budget     Decimal?  @default(0)
  spent      Decimal?  @default(0)
  startDate  DateTime?
  endDate    DateTime?
  externalId String?   @unique @db.Text // ID from ad platform (e.g., Facebook Campaign ID)
  userId     String // User ownership

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Instagram / Ad Fields
  objective     String?  // e.g. "LEAD_GENERATION", "TRAFFIC"
  creativeType  String?  // e.g. "VIDEO", "IMAGE"
  destinationUrl String? // Landing Page URL
  videoUrl      String?  // Ad Video URL
  
  impressions   Int      @default(0)
  clicks        Int      @default(0)
  conversions   Int      @default(0)
  spend         Decimal? @db.Decimal(10, 2)

  // Relations
  adSets            AdSet[]
  insights          Insight[]
  leads             Lead[] // NEW: Campaigns can have multiple leads
  instagramMessages InstagramMessage[]
  whatsappMessages  WhatsappMessage[]

  @@index([userId])
}

model AdSet {
  id         String    @id @default(cuid())
  campaignId String
  name       String
  status     String    @default("DRAFT")
  budget     Decimal?
  targeting  Json? // JSON to store targeting details (age, location, interests)
  startDate  DateTime?
  endDate    DateTime?
  externalId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  campaign Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  ads      Ad[]
  insights Insight[]

  @@index([campaignId])
}

model Ad {
  id         String  @id @default(cuid())
  adSetId    String
  name       String
  status     String  @default("DRAFT")
  creativeId String?
  externalId String?
  previewUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  adSet          AdSet             @relation(fields: [adSetId], references: [id], onDelete: Cascade)
  insights       Insight[]

  @@index([adSetId])
  @@index([creativeId])
}


model Insight {
  id         String   @id @default(cuid())
  date       DateTime
  campaignId String?
  adSetId    String?
  adId       String?

  impressions Int      @default(0)
  clicks      Int      @default(0)
  spend       Decimal  @default(0)
  leads       Int      @default(0)
  reach       Int      @default(0)
  ctr         Decimal? @default(0) // Click-through rate
  cpc         Decimal? @default(0) // Cost per click
  cpm         Decimal? @default(0) // Cost per 1000 impressions

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  campaign Campaign? @relation(fields: [campaignId], references: [id])
  adSet    AdSet?    @relation(fields: [adSetId], references: [id])
  ad       Ad?       @relation(fields: [adId], references: [id])

  @@index([date])
  @@index([campaignId])
  @@index([adSetId])
  @@index([adId])
}

// ===== INSTAGRAM INTEGRATION MODELS =====

model InstagramAccount {
  id                String    @id @default(cuid())
  userId            String    // ✅ Required for ownership
  instagramUserId   String    @unique
  instagramUsername String
  accessToken       String // يجب تشفيره في الإنتاج
  businessAccountId String
  followers         Int       @default(0)
  engagementRate    Float     @default(0)
  status            String    @default("active") // active, inactive, expired
  lastSyncedAt      DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  campaigns InstagramCampaign[]
  ads       InstagramAd[]
  messages  InstagramMessage[]
  posts     InstagramPost[]

  @@index([userId])
}

model InstagramPost {
  id                String    @id @default(cuid())
  accountId         String
  caption           String?   @db.Text
  mediaUrl          String    @db.Text // Public URL from Supabase Storage
  mediaType         String    @default("IMAGE") // IMAGE, VIDEO, CAROUSEL
  status            String    @default("DRAFT") // DRAFT, SCHEDULED, PUBLISHED, FAILED
  scheduledFor      DateTime?
  publishedAt       DateTime?
  instagramMediaId  String?   // ID returned from Instagram after publishing
  userId            String?   // User who created the post

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  account           InstagramAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([status])
  @@index([scheduledFor])
}

model InstagramCampaign {
  id             String    @id @default(cuid())
  accountId      String
  name           String
  description    String?
  budget         Decimal   @default(0)
  targetAudience Json? // JSON object مع demographics, interests, etc
  status         String    @default("draft") // draft, scheduled, active, paused, completed
  startDate      DateTime?
  endDate        DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  account    InstagramAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  ads        InstagramAd[]
  AdCampaign AdCampaign[]

  @@index([accountId])
}

model InstagramAd {
  id           String  @id @default(cuid())
  accountId    String
  campaignId   String
  adAccountId  String?
  adType       String // image, carousel, video, collection
  headline     String
  description  String  @db.Text
  callToAction String  @default("SHOP_NOW") // SHOP_NOW, LEARN_MORE, BOOK_NOW
  status       String  @default("draft") // draft, pending_review, active, paused, rejected, completed

  // Performance metrics
  impressions Int     @default(0)
  clicks      Int     @default(0)
  conversions Int     @default(0)
  spend       Decimal @default(0)
  ctr         Float   @default(0) // click-through rate
  cpc         Decimal @default(0) // cost per click
  cpa         Decimal @default(0) // cost per acquisition

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  account     InstagramAccount  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  campaign    InstagramCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  assets      AdAsset[]
  variants    AdVariant[]
  performance AdPerformance[]

  @@index([accountId])
  @@index([campaignId])
}

model AdAsset {
  id         String   @id @default(cuid())
  adId       String
  assetType  String // image, video, carouselItem
  url        String // رابط الملف في Supabase Storage
  thumbnail  String?
  altText    String?
  dimensions Json? // { width: number, height: number }
  fileSize   Int?
  duration   Int? // بالثواني للفيديو
  uploadedAt DateTime @default(now())

  // Relations
  ad InstagramAd @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@index([adId])
}

model AdVariant {
  id          String  @id @default(cuid())
  adId        String
  variantName String // Variant A, Variant B, etc
  headline    String?
  description String? @db.Text
  imageId     String?
  status      String  @default("active") // active, inactive

  // Performance metrics specific to variant
  impressions Int     @default(0)
  clicks      Int     @default(0)
  conversions Int     @default(0)
  spend       Decimal @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ad InstagramAd @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@index([adId])
}

model AdPerformance {
  id           String   @id @default(cuid())
  adId         String
  date         DateTime
  impressions  Int      @default(0)
  clicks       Int      @default(0)
  conversions  Int      @default(0)
  spend        Decimal  @default(0)
  reach        Int      @default(0)
  saveCount    Int      @default(0)
  shareCount   Int      @default(0)
  likeCount    Int      @default(0)
  commentCount Int      @default(0)
  createdAt    DateTime @default(now())

  // Relations
  ad InstagramAd @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@index([adId])
  @@index([date])
}


// ===== UNIFIED INBOX MODELS =====

model Channel {
  id          String   @id @default(cuid())
  type        String // "instagram" | "whatsapp" | "email" | "sms"
  externalId  String // ig_business_id, phone_number_id, etc.
  displayName String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  conversations Conversation[]

  @@unique([type, externalId])
}

model Conversation {
  id         String  @id @default(cuid())
  channelId  String
  channel    Channel @relation(fields: [channelId], references: [id])
  externalId String? // thread_id, conversation_id, or synthetic ID

  // Contact info
  contactId     String? // External contact ID (IG user ID, phone number)
  contactName   String?
  contactHandle String? // @username for IG, normalized phone for WA
  lastMessageAt DateTime?
  status        String    @default("ACTIVE") // ACTIVE, ARCHIVED, CLOSED

  // Relations
  messages Message[]

  @@index([channelId])
  @@index([contactId])
  @@index([contactHandle])
  @@index([lastMessageAt])
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  externalId     String? // Platform message ID
  direction      String // "inbound" | "outbound"
  source         String // "instagram" | "whatsapp" | "email" | "sms"
  text           String?      @db.Text
  payload        Json? // For media, attachments, etc.
  isRead         Boolean      @default(false)
  aiGenerated    Boolean      @default(false)

  // Metadata
  metadata Json? // Platform-specific data

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([conversationId])
  @@index([externalId])
  @@index([direction])
  @@index([source])
  @@index([createdAt])
}


// ===== INSTAGRAM MESSAGES MODELS (Updated) =====

model InstagramMessage {
  id                String    @id @default(cuid())
  senderId          String? // Instagram User ID of sender
  recipientId       String? // Instagram User ID of recipient
  username          String? // Instagram username
  message           String   @db.Text
  timestamp         DateTime // When message was sent
  messageId         String   @unique // Instagram message ID
  isFromUser        Boolean  @default(true) // true if from user, false if from business
  direction         String   @default("inbound") // inbound | outbound
  instagramAccountId String? // ✅ Link to InstagramAccount

  // Relations to existing CRM
  leadId     String? @db.Text // Link to lead if converted
  campaignId String? @db.Text // Link to campaign if from ad

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lead     Lead?             @relation(fields: [leadId], references: [id], onDelete: SetNull)
  campaign Campaign?         @relation(fields: [campaignId], references: [id])
  instagramAccount InstagramAccount? @relation(fields: [instagramAccountId], references: [id])

  @@index([senderId])
  @@index([recipientId])
  @@index([messageId])
  @@index([leadId])
  @@index([campaignId])
  @@index([timestamp])
  @@index([instagramAccountId])
}


// ===== WHATSAPP INTEGRATION MODELS =====

model WhatsappAccount {
  id             String    @id @default(cuid())
  userId         String    // ✅ Required for ownership
  phoneNumberId  String    @unique
  phoneNumber    String
  businessName  String?
  accessToken   String     // يجب تشفيره في الإنتاج
  status         String    @default("active") // active, inactive, expired
  lastSyncedAt   DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  messages WhatsappMessage[]

  @@index([userId])
}

model WhatsappMessage {
  id                 String    @id @default(cuid())
  senderId           String? // WhatsApp User ID of sender
  recipientId        String? // WhatsApp User ID of recipient
  phoneNumber        String // Phone number of sender/receiver
  message            String    @db.Text
  timestamp          DateTime // When message was sent/received
  messageId          String    @unique // WhatsApp message ID
  isFromUser         Boolean   @default(true) // true if from customer, false if from business
  direction          String    @default("INBOUND") // INBOUND, OUTBOUND
  whatsappAccountId  String?   // ✅ Link to WhatsappAccount

  // Relations to existing CRM
  leadId     String? @db.Text // Link to lead if converted
  campaignId String? @db.Text // Link to campaign if from campaign

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lead             Lead?            @relation(fields: [leadId], references: [id], onDelete: SetNull)
  campaign         Campaign?        @relation(fields: [campaignId], references: [id])
  whatsappAccount  WhatsappAccount? @relation(fields: [whatsappAccountId], references: [id])

  @@index([phoneNumber])
  @@index([messageId])
  @@index([leadId])
  @@index([campaignId])
  @@index([timestamp])
  @@index([direction])
  @@index([whatsappAccountId])
}

// ===== AI ASSISTANT MODELS =====

model AIAssistant {
  id           String   @id @default(cuid())
  name         String
  description  String?
  role         String? // e.g. "inbox_auto_reply", "ads_brain", "crm_helper"
  systemPrompt String   @db.Text
  isActive     Boolean  @default(true)
  userId       String? // User ownership
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([role])
  @@index([isActive])
  @@index([userId])
}

model AIConversation {
  id        String   @id @default(cuid())
  userId    String? // User ownership
  title     String?
  mode      String? // "general", "crm", "instagram"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  messages AIConversationMessage[]

  @@index([userId])
  @@index([mode])
  @@map("ai_conversations")
}

model AIConversationMessage {
  id             String         @id @default(cuid())
  conversationId String
  conversation   AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           String // "user", "assistant", "system"
  content        String         @db.Text
  timestamp      DateTime
  createdAt      DateTime       @default(now())

  @@index([conversationId])
  @@map("ai_conversation_messages")
}

// ===== AD CAMPAIGN MODELS =====

model AdCampaign {
  id          String    @id @default(cuid())
  name        String
  objective   String?
  status      String    @default("draft") // draft | active | paused | completed
  platform    String? // facebook | instagram | whatsapp | google | native
  dailyBudget Float?
  totalBudget Float?
  currency    String?   @default("AED")
  startDate   DateTime?
  endDate     DateTime?
  userId      String? // User ownership
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // optional link إلى InstagramCampaign الموجودة مسبقًا
  instagramCampaignId String?
  instagramCampaign   InstagramCampaign? @relation(fields: [instagramCampaignId], references: [id])

  creatives AdCreative[]

  @@index([userId])
  @@map("ad_campaigns")
}

model AdCreative {
  id           String   @id @default(cuid())
  campaignId   String
  headline     String
  description  String?
  imageUrl     String?
  callToAction String?
  placement    String? // feed | stories | reels ...
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campaign AdCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@map("ad_creatives")
}

// ===== AI AUTO REPLY RULES (Updated & Fixed) =====

model AIAutoReplyRule {
  id                       String   @id @default(uuid())
  userId                   String   // ✅ Required for ownership
  name                     String
  keyword                  String?
  response                 String?  @db.Text
  useAI                    Boolean  @default(false)
  assistantId              String?
  platform                 String   // "instagram" | "whatsapp" | "all"
  enabled                  Boolean  @default(true)
  isActive                 Boolean  @default(true) // ✅ For compatibility with API
  priority                 Int      @default(0)
  
  // ✅ Complete Time Restriction fields
  timeRestrictionEnabled   Boolean  @default(false)
  startTime                String?  // HH:mm format
  endTime                  String?  // HH:mm format
  timezone                 String?  // IANA timezone
  
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([platform])
  @@index([enabled])
  @@index([isActive])
  @@map("ai_auto_reply_rules")
}

// ===== NOTIFICATIONS MODULE =====

model Notification {
  id        String   @id @default(cuid())
  type      String   // e.g., "LEAD_ASSIGNMENT"
  title     String
  body      String
  leadId    String?
  userId    String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  
  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lead      Lead?    @relation(fields: [leadId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([leadId])
  @@index([isRead])
}
